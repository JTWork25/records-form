<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Records Assessment</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Mobile-First Base Styles */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; 
            padding: 10px; 
            line-height: 1.6;
            font-size: 16px; /* Prevents iOS zoom on focus */
            -webkit-font-smoothing: antialiased;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 80px; /* Space for fixed navigation */
        }
        
        h1 { 
            color: #2c3e50; 
            margin-bottom: 10px; 
            font-size: 1.75em;
        }
        
        h2 { 
            color: #34495e; 
            margin: 20px 0 15px; 
            font-size: 1.5em;
        }
        
        h3 { 
            color: #7f8c8d; 
            margin: 15px 0 10px; 
            font-size: 1.2em;
        }
        
        h4 { 
            color: #95a5a6; 
            margin: 10px 0 8px; 
            font-size: 1.1em;
        }
        
        .hidden { display: none !important; }
        
        /* Mobile-Optimized Buttons - iOS requires 44x44px minimum */
        .btn { 
            padding: 14px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600; 
            transition: all 0.3s;
            min-height: 44px;
            display: inline-block;
            text-align: center;
            touch-action: manipulation;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:active { background: #2980b9; }
        
        .btn-success { background: #27ae60; color: white; }
        .btn-success:active { background: #229954; }
        
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:active { background: #7f8c8d; }
        
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:active { background: #c0392b; }
        
        .btn-small { 
            padding: 12px 16px; 
            font-size: 14px;
            min-height: 44px;
        }
        
        .btn-group { 
            display: flex; 
            flex-direction: column;
            gap: 10px;
        }
        
        /* Form Elements - Optimized for Mobile Input */
        .form-group { 
            margin-bottom: 20px;
        }
        
        .form-row { 
            display: flex; 
            flex-direction: column;
            gap: 15px;
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #2c3e50;
            font-size: 16px;
        }
        
        label .required { color: #e74c3c; }
        
        input[type="text"], 
        input[type="email"], 
        input[type="tel"], 
        input[type="number"], 
        textarea, 
        select { 
            width: 100%; 
            padding: 14px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; /* Prevents iOS zoom */
            -webkit-appearance: none;
            appearance: none;
            background: white;
            min-height: 44px;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        textarea { 
            min-height: 100px; 
            resize: vertical;
            font-family: inherit;
        }
        
        select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            padding-right: 40px;
        }
        
        .error { 
            color: #e74c3c; 
            font-size: 0.9em; 
            margin-top: 5px; 
            display: block;
        }
        
        /* Assessment List */
        .assessment-list { margin-top: 20px; }
        
        .assessment-card { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column;
            gap: 10px;
            background: #fafafa;
            min-height: 44px;
        }
        
        .assessment-info h3 { 
            margin: 0 0 5px 0; 
            color: #2c3e50;
        }
        
        .assessment-meta { 
            font-size: 0.9em; 
            color: #7f8c8d;
        }
        
        .status-badge { 
            display: inline-block; 
            padding: 5px 12px; 
            border-radius: 4px; 
            font-size: 0.85em; 
            font-weight: bold;
        }
        
        .status-draft { background: #f39c12; color: white; }
        .status-complete { background: #27ae60; color: white; }
        
        /* Progress Bar - Mobile Optimized */
        .progress-bar { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 20px; 
            position: relative;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .progress-bar::before { 
            content: ''; 
            position: absolute; 
            top: 30px; 
            left: 0; 
            right: 0; 
            height: 2px; 
            background: #ddd; 
            z-index: 0;
        }
        
        .progress-step { 
            flex: 1; 
            text-align: center; 
            position: relative;
            min-width: 60px;
        }
        
        .progress-step-circle { 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            background: #ddd; 
            color: #7f8c8d; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 8px; 
            font-weight: bold; 
            transition: all 0.3s;
            position: relative;
            z-index: 1;
        }
        
        .progress-step.active .progress-step-circle { 
            background: #3498db; 
            color: white;
        }
        
        .progress-step.completed .progress-step-circle { 
            background: #27ae60; 
            color: white;
        }
        
        .progress-step-label { 
            font-size: 0.75em; 
            color: #7f8c8d;
            word-wrap: break-word;
        }
        
        /* Accordion */
        .accordion-item { 
            border: 1px solid #ddd; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            overflow: hidden;
        }
        
        .accordion-header { 
            background: #f8f9fa; 
            padding: 16px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: 600;
            min-height: 44px;
            font-size: 16px;
        }
        
        .accordion-header:active { 
            background: #e9ecef;
        }
        
        .accordion-content { 
            padding: 15px; 
            display: none;
        }
        
        .accordion-content.active { 
            display: block;
        }
        
        .accordion-toggle { 
            transition: transform 0.3s;
            font-size: 20px;
        }
        
        .accordion-toggle.active { 
            transform: rotate(180deg);
        }
        
        /* Cards */
        .card { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            background: #fafafa;
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* Mobile-Optimized Navigation - Fixed at Bottom */
        .form-navigation { 
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex; 
            justify-content: space-between;
            padding: 10px;
            border-top: 2px solid #eee;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            gap: 10px;
        }
        
        .form-navigation .btn {
            flex: 1;
            margin-bottom: 0;
        }
        
        /* Checkbox/Radio Groups */
        .checkbox-group, .radio-group { 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }
        
        .checkbox-item, .radio-item { 
            display: flex; 
            align-items: center; 
            gap: 12px;
            min-height: 44px;
        }
        
        .checkbox-item input,
        .radio-item input {
            width: 24px;
            height: 24px;
            min-width: 24px;
        }
        
        /* Metadata Field Editor */
        .metadata-field { 
            display: flex; 
            gap: 10px; 
            align-items: flex-start; 
            margin-bottom: 10px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: white;
            flex-wrap: wrap;
        }
        
        .metadata-field-order { 
            width: 30px; 
            text-align: center; 
            font-weight: bold; 
            color: #7f8c8d; 
            padding-top: 12px;
            font-size: 18px;
        }
        
        .metadata-field-controls { 
            display: flex; 
            flex-direction: column; 
            gap: 5px;
        }
        
        .metadata-field-inputs { 
            flex: 1; 
            display: flex; 
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }
        
        /* Section Divider */
        .section-divider { 
            border-top: 2px solid #e0e0e0; 
            margin: 25px 0; 
            padding-top: 20px;
        }
        
        /* Review Section */
        .review-section { 
            margin-bottom: 25px;
        }
        
        .review-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px;
            font-size: 14px;
        }
        
        .review-table th, .review-table td { 
            padding: 12px 8px; 
            border: 1px solid #ddd; 
            text-align: left;
        }
        
        .review-table th { 
            background: #f8f9fa; 
            font-weight: 600;
        }
        
        /* Photo Upload - Mobile Optimized */
        .photo-preview { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            margin-top: 10px;
        }
        
        .photo-preview-item { 
            position: relative; 
            width: calc(50% - 5px); 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 5px; 
            background: white;
        }
        
        .photo-preview-item img { 
            width: 100%; 
            height: 150px; 
            object-fit: cover; 
            border-radius: 4px;
        }
        
        .photo-remove { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: #e74c3c; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 36px; 
            height: 36px; 
            cursor: pointer; 
            font-size: 20px; 
            line-height: 1; 
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-remove:active { 
            background: #c0392b;
        }
        
        /* Tablet and Desktop Adjustments */
        @media (min-width: 768px) {
            body { padding: 20px; }
            
            .container { 
                padding: 30px;
                margin-bottom: 30px;
            }
            
            .btn { 
                width: auto;
                display: inline-block;
            }
            
            .btn-group { 
                flex-direction: row;
            }
            
            .form-row { 
                flex-direction: row;
            }
            
            .form-navigation {
                position: relative;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 2px solid #eee;
                box-shadow: none;
                padding: 20px 0 0 0;
            }
            
            .assessment-card {
                flex-direction: row;
                align-items: center;
            }
            
            .photo-preview-item {
                width: 150px;
            }
            
            .metadata-field-inputs {
                flex-direction: row;
            }
        }
        
        /* Landscape Phone Adjustments */
        @media (max-width: 767px) and (orientation: landscape) {
            .progress-bar {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
        }
        
        /* OneDrive Integration Styles */
        .cloud-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 14px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cloud-status:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .cloud-status.connected {
            color: #27ae60;
            border: 2px solid #27ae60;
        }
        
        .cloud-status.disconnected {
            color: #95a5a6;
            border: 2px solid #ddd;
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 90%;
            max-width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        
        .settings-overlay.active {
            display: block;
        }
        
        .settings-header {
            background: #3498db;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        
        .settings-body {
            padding: 20px;
        }
        
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-section:last-child {
            border-bottom: none;
        }
        
        .settings-section h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .connection-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .connection-card.connected {
            border-color: #27ae60;
            background: #d4edda;
        }
        
        .connection-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .connection-icon {
            font-size: 24px;
        }
        
        .connection-details {
            flex: 1;
        }
        
        .connection-status {
            font-weight: 600;
            font-size: 14px;
        }
        
        .connection-email {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .upload-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 3000;
            min-width: 300px;
            max-width: 90%;
            display: none;
        }
        
        .upload-modal.active {
            display: block;
        }
        
        .upload-modal h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar-upload {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s;
            border-radius: 4px;
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2999;
            display: none;
        }
        
        .modal-overlay.active {
            display: block;
        }
        
        .success-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .error-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 15px;
            color: #e74c3c;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .cloud-folder-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .security-badge {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        @media (max-width: 768px) {
            .cloud-status {
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .settings-panel {
                width: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- OneDrive Cloud Status -->
    <div class="cloud-status disconnected" id="cloudStatus" onclick="toggleSettings()">
        <span id="cloudIcon">‚òÅÔ∏è</span>
        <span id="cloudText">OneDrive</span>
        <span class="security-badge">SECURE</span>
    </div>
    
    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 style="margin: 0; font-size: 20px;">Settings</h2>
            <button class="settings-close" onclick="toggleSettings()">√ó</button>
        </div>
        <div class="settings-body">
            <div class="settings-section">
                <h3>‚òÅÔ∏è OneDrive Connection</h3>
                <div class="connection-card" id="connectionCard">
                    <div class="connection-info">
                        <span class="connection-icon">‚òÅÔ∏è</span>
                        <div class="connection-details">
                            <div class="connection-status" id="connectionStatus">Not Connected</div>
                            <div class="connection-email" id="connectionEmail"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="connectBtn" onclick="connectOneDrive()" style="width: 100%; margin-bottom: 0;">Connect OneDrive</button>
                    <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectOneDrive()" style="width: 100%; margin-bottom: 0; display: none;">Disconnect</button>
                </div>
                <p style="font-size: 12px; color: #27ae60; margin-top: 10px;">
                    <strong>üîê Secure PKCE Authentication</strong><br>
                    No secrets stored in app. Industry-standard OAuth 2.0.
                </p>
            </div>
            
            <div class="settings-section" id="folderSection" style="display: none;">
                <h3>üìÅ Upload Folder</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Assessments will be uploaded to:</p>
                <input type="text" class="cloud-folder-input" id="oneDriveFolder" value="/Assessments/" placeholder="/Assessments/">
                <button class="btn btn-secondary" onclick="saveOneDriveFolder()" style="width: 100%; margin-top: 10px; margin-bottom: 0;">Save Folder Path</button>
            </div>
            
            <div class="settings-section">
                <h3>‚öôÔ∏è Setup Helper</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
                    If you get "redirect_uri" errors when connecting, click below to see your redirect URI and setup instructions.
                </p>
                <button class="btn btn-primary" onclick="showRedirectUriHelper()" style="width: 100%; margin-bottom: 0;">
                    üìã Show My Redirect URI
                </button>
                <div id="redirectUriInfo" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; font-size: 13px; line-height: 1.6;">
                    <strong>Your Redirect URI:</strong><br>
                    <input type="text" id="redirectUriDisplay" readonly style="width: 100%; padding: 8px; margin: 10px 0; font-family: monospace; font-size: 11px; background: white; border: 1px solid #ddd; border-radius: 4px;">
                    <button class="btn btn-secondary" onclick="copyRedirectUri()" style="width: 100%; margin-bottom: 10px;">üìã Copy to Clipboard</button>
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
                    <strong>üìù Azure Setup Steps:</strong><br>
                    1. Copy the URI above<br>
                    2. Go to <a href="https://portal.azure.com" target="_blank" style="color: #0066cc;">portal.azure.com</a><br>
                    3. Azure AD ‚Üí App registrations<br>
                    4. Click "Records Assessment Form"<br>
                    5. Click "Authentication" (left menu)<br>
                    6. Click "Add a platform"<br>
                    7. Select "Mobile and desktop applications"<br>
                    8. Scroll to bottom ‚Üí "Custom redirect URIs"<br>
                    9. Paste your URI<br>
                    10. Click "Configure" then "Save"<br>
                    11. Done! Try connecting again ‚úÖ
                </div>
            </div>
            
            <div class="settings-section">
                <h3>‚ÑπÔ∏è About</h3>
                <p style="font-size: 14px; color: #666; line-height: 1.8;">
                    <strong>Version:</strong> 3.0 Secure Edition<br>
                    <strong>Security:</strong> PKCE Flow (OAuth 2.0)<br>
                    <strong>Features:</strong><br>
                    ‚Ä¢ One-click cloud upload<br>
                    ‚Ä¢ Automatic sync to laptop<br>
                    ‚Ä¢ Offline support<br>
                    ‚Ä¢ JSON + Excel + Photos<br>
                    ‚Ä¢ No secrets in code üîê
                </p>
            </div>
        </div>
    </div>
    
    <!-- Upload Modal -->
    <div class="modal-overlay" id="uploadOverlay"></div>
    <div class="upload-modal" id="uploadModal">
        <div id="uploadContent">
            <h3 id="uploadTitle">Uploading to OneDrive...</h3>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar-upload">
                    <div class="progress-bar-fill" id="progressBarFill"></div>
                </div>
                <div class="progress-text" id="progressText">Preparing files...</div>
            </div>
            <div class="modal-actions" id="uploadActions" style="display: none;">
                <button class="btn btn-primary" onclick="closeUploadModal()" style="flex: 1; margin-bottom: 0;">Done</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div id="assessmentListView">
            <h1>Records Assessment System</h1>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Manage and export records assessments</p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="createNewAssessment()">+ New Assessment</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Assessment</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAssessment(event)">
            </div>
            <div class="assessment-list" id="assessmentList"></div>
        </div>

        <div id="assessmentFormView" class="hidden">
            <h1>Records Assessment Form</h1>
            <div class="progress-bar" id="progressBar">
                <div class="progress-step" data-step="1"><div class="progress-step-circle">1</div><div class="progress-step-label">Client</div></div>
                <div class="progress-step" data-step="2"><div class="progress-step-circle">2</div><div class="progress-step-label">Sites</div></div>
                <div class="progress-step" data-step="3"><div class="progress-step-circle">3</div><div class="progress-step-label">Storage</div></div>
                <div class="progress-step" data-step="4"><div class="progress-step-circle">4</div><div class="progress-step-label">Collections</div></div>
                <div class="progress-step" data-step="5"><div class="progress-step-circle">5</div><div class="progress-step-label">Review</div></div>
            </div>

            <form id="assessmentForm">
                <!-- Step 1: Client & Contacts -->
                <div class="form-step" id="step1">
                    <h2>Step 1: Client & Contacts</h2>
                    <div class="form-group">
                        <label>Company Name <span class="required">*</span></label>
                        <input type="text" id="clientName" required>
                        <span class="error" id="clientNameError"></span>
                    </div>
                    <div class="form-group">
                        <label>Internal Company ID</label>
                        <input type="text" id="clientInternalId">
                    </div>
                    <h3>Contacts</h3>
                    <div id="contactsContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addContact()">+ Add Contact</button>
                </div>

                <!-- Step 2: Sites & Buildings -->
                <div class="form-step hidden" id="step2">
                    <h2>Step 2: Sites & Buildings</h2>
                    <div id="sitesContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addSite()">+ Add Site</button>
                </div>

                <!-- Step 3: Storage Areas -->
                <div class="form-step hidden" id="step3">
                    <h2>Step 3: Storage Areas & Logistics</h2>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Add storage areas for each building defined in Step 2.</p>
                    <div id="storageAreasContainer"></div>
                </div>

                <!-- Step 4: Collections (merged with containers, media, and metadata) -->
                <div class="form-step hidden" id="step4">
                    <h2>Step 4: Collections</h2>
                    <div id="collectionsContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addCollection()">+ Add Collection</button>
                </div>

                <!-- Step 5: Review & Export -->
                <div class="form-step hidden" id="step5">
                    <h2>Step 5: Review & Export</h2>
                    <div id="reviewContainer"></div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="button" class="btn btn-success" onclick="uploadToOneDrive()" id="oneDriveUploadBtn">
                            <span style="font-size: 18px;">‚òÅÔ∏è</span> Upload to OneDrive
                        </button>
                        <button type="button" class="btn btn-warning" onclick="testFilePermissions()" id="testPermissionsBtn" style="background: #ff9800; border-color: #ff9800;">
                            üß™ Test File Permissions
                        </button>
                        <button type="button" class="btn btn-primary" onclick="exportCompletePackage()">üì¶ Export Package (ZIP)</button>
                        <button type="button" class="btn btn-secondary" onclick="exportToExcel()">üì• Export Excel Only</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 8px; font-size: 14px; border: 2px solid #27ae60;">
                        <strong>üîê Secure Upload:</strong> Uses PKCE authentication - no secrets in your code!<br>
                        <strong>üìÅ Files go to:</strong> OneDrive ‚Üí Apps ‚Üí Records Assessment Personal<br>
                        <strong>üí° Note:</strong> Using app folder (works without app verification)
                    </div>
                </div>

                <div class="form-navigation">
                    <div>
                        <button type="button" class="btn btn-secondary" onclick="backToList()">‚Üê Back to List</button>
                        <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()">‚Üê Previous</button>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">Next ‚Üí</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let currentAssessment = null;
        let assessments = JSON.parse(localStorage.getItem('assessments') || '[]');

        const US_STATES = [{code:'AL',name:'Alabama'},{code:'AK',name:'Alaska'},{code:'AZ',name:'Arizona'},{code:'AR',name:'Arkansas'},{code:'CA',name:'California'},{code:'CO',name:'Colorado'},{code:'CT',name:'Connecticut'},{code:'DE',name:'Delaware'},{code:'DC',name:'District of Columbia'},{code:'FL',name:'Florida'},{code:'GA',name:'Georgia'},{code:'HI',name:'Hawaii'},{code:'ID',name:'Idaho'},{code:'IL',name:'Illinois'},{code:'IN',name:'Indiana'},{code:'IA',name:'Iowa'},{code:'KS',name:'Kansas'},{code:'KY',name:'Kentucky'},{code:'LA',name:'Louisiana'},{code:'ME',name:'Maine'},{code:'MD',name:'Maryland'},{code:'MA',name:'Massachusetts'},{code:'MI',name:'Michigan'},{code:'MN',name:'Minnesota'},{code:'MS',name:'Mississippi'},{code:'MO',name:'Missouri'},{code:'MT',name:'Montana'},{code:'NE',name:'Nebraska'},{code:'NV',name:'Nevada'},{code:'NH',name:'New Hampshire'},{code:'NJ',name:'New Jersey'},{code:'NM',name:'New Mexico'},{code:'NY',name:'New York'},{code:'NC',name:'North Carolina'},{code:'ND',name:'North Dakota'},{code:'OH',name:'Ohio'},{code:'OK',name:'Oklahoma'},{code:'OR',name:'Oregon'},{code:'PA',name:'Pennsylvania'},{code:'RI',name:'Rhode Island'},{code:'SC',name:'South Carolina'},{code:'SD',name:'South Dakota'},{code:'TN',name:'Tennessee'},{code:'TX',name:'Texas'},{code:'UT',name:'Utah'},{code:'VT',name:'Vermont'},{code:'VA',name:'Virginia'},{code:'WA',name:'Washington'},{code:'WV',name:'West Virginia'},{code:'WI',name:'Wisconsin'},{code:'WY',name:'Wyoming'}];

        const METADATA_TEMPLATES = {
            'Custom': [],
            'HR Records': [{name:'Last Name',critical:true},{name:'First Name',critical:true},{name:'Employee ID',critical:true},{name:'Date of Hire',critical:false},{name:'Department',critical:false}],
            'Medical Records': [{name:'Patient Last Name',critical:true},{name:'Patient First Name',critical:true},{name:'Medical Record Number',critical:true},{name:'Date of Birth',critical:true},{name:'Date of Service',critical:false}],
            'Financial Records': [{name:'Account Number',critical:true},{name:'Transaction Date',critical:true},{name:'Vendor/Customer Name',critical:false},{name:'Amount',critical:false},{name:'Document Type',critical:false}],
            'Blueprints/Engineering': [{name:'Address',critical:true},{name:'Building Name',critical:false},{name:'Floor',critical:false},{name:'Drawing Type',critical:false},{name:'Drawing Number',critical:true}],
            'Legal Records': [{name:'Document Type',critical:true},{name:'Case Number',critical:false},{name:'Party Name',critical:true},{name:'Date Filed',critical:false},{name:'Attorney',critical:false}]
        };

        document.addEventListener('DOMContentLoaded', () => renderAssessmentList());

        // ========== Assessment Management ==========
        function createNewAssessment() {
            currentAssessment = {
                id: generateId(),
                name: '',
                status: 'Draft',
                client: { name: '', internalId: '', contacts: [] },
                sites: [],
                collections: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            showFormView();
            addContact();
        }

        function editAssessment(id) {
            currentAssessment = assessments.find(a => a.id === id);
            if (currentAssessment) {
                currentAssessment.collections = currentAssessment.collections || [];
                showFormView();
                populateForm();
            }
        }

        function deleteAssessment(id) {
            if (confirm('Delete this assessment? This cannot be undone.')) {
                assessments = assessments.filter(a => a.id !== id);
                localStorage.setItem('assessments', JSON.stringify(assessments));
                renderAssessmentList();
            }
        }

        function showFormView() {
            document.getElementById('assessmentListView').classList.add('hidden');
            document.getElementById('assessmentFormView').classList.remove('hidden');
            currentStep = 1;
            updateProgress();
        }

        function backToList() {
            if (confirm('Return to list? Any unsaved changes will be lost.')) {
                document.getElementById('assessmentFormView').classList.add('hidden');
                document.getElementById('assessmentListView').classList.remove('hidden');
                renderAssessmentList();
            }
        }

        function renderAssessmentList() {
            const container = document.getElementById('assessmentList');
            if (assessments.length === 0) {
                container.innerHTML = '<p style="color:#7f8c8d;margin-top:20px;">No assessments yet. Create your first assessment to get started.</p>';
                return;
            }
            container.innerHTML = assessments.map(a => `
                <div class="assessment-card">
                    <div class="assessment-info">
                        <h3>${escapeHtml(a.client.name || 'Unnamed Assessment')}<span class="status-badge status-${a.status.toLowerCase()}">${a.status}</span></h3>
                        <div class="assessment-meta">Created: ${new Date(a.createdAt).toLocaleDateString()} | Modified: ${new Date(a.updatedAt).toLocaleDateString()}</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-small" onclick="editAssessment('${a.id}')">Edit</button>
                        <button class="btn btn-success btn-small" onclick="exportAssessmentToExcel('${a.id}')">Export</button>
                        <button class="btn btn-danger btn-small" onclick="deleteAssessment('${a.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== Navigation ==========
        function nextStep() {
            if (!validateCurrentStep()) return;
            saveFormData();
            if (currentStep < 5) {
                document.getElementById(`step${currentStep}`).classList.add('hidden');
                currentStep++;
                document.getElementById(`step${currentStep}`).classList.remove('hidden');
                updateProgress();
                renderDynamicContent();
                window.scrollTo(0, 0);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                saveFormData();
                document.getElementById(`step${currentStep}`).classList.add('hidden');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.remove('hidden');
                updateProgress();
                window.scrollTo(0, 0);
            }
        }

        function updateProgress() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNum = index + 1;
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });
            document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'inline-block';
            document.getElementById('nextBtn').style.display = currentStep === 5 ? 'none' : 'inline-block';
        }

        // ========== Validation ==========
        function validateCurrentStep() {
            clearErrors();
            if (currentStep === 1) {
                if (!document.getElementById('clientName').value.trim()) {
                    showError('clientNameError', 'Company name is required');
                    return false;
                }
                if (document.querySelectorAll('.contact-card').length === 0) {
                    alert('Please add at least one contact');
                    return false;
                }
            }
            return true;
        }

        function clearErrors() {
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            if (el) el.textContent = msg;
        }

        // ========== Save/Load Form Data ==========
        function saveFormData() {
            if (!currentAssessment) return;

            // Step 1: Client & Contacts
            currentAssessment.client.name = document.getElementById('clientName').value.trim();
            currentAssessment.client.internalId = document.getElementById('clientInternalId').value.trim();
            currentAssessment.client.contacts = Array.from(document.querySelectorAll('.contact-card')).map(card => ({
                firstName: card.querySelector('[data-field="contactFirstName"]').value,
                lastName: card.querySelector('[data-field="contactLastName"]').value,
                role: card.querySelector('[data-field="contactRole"]').value,
                phone: card.querySelector('[data-field="contactPhone"]').value,
                email: card.querySelector('[data-field="contactEmail"]').value
            }));

            // Step 2: Sites & Buildings
            currentAssessment.sites = Array.from(document.querySelectorAll('#sitesContainer > .accordion-item')).map(siteEl => {
                const content = siteEl.querySelector('.accordion-content');
                return {
                    id: siteEl.dataset.id,
                    name: content.querySelector('[data-field="siteName"]').value,
                    address: {
                        street: content.querySelector('[data-field="siteStreetAddress"]').value,
                        city: content.querySelector('[data-field="siteCity"]').value,
                        state: content.querySelector('[data-field="siteState"]').value,
                        zipCode: content.querySelector('[data-field="siteZipCode"]').value
                    },
                    buildings: Array.from(content.querySelectorAll('.card[data-id]')).map(bldg => ({
                        id: bldg.dataset.id,
                        name: bldg.querySelector('[data-field="buildingName"]').value,
                        description: bldg.querySelector('[data-field="buildingDescription"]').value,
                        storageAreas: []
                    }))
                };
            });

            // Step 3: Storage Areas (attached to buildings)
            document.querySelectorAll('#storageAreasContainer > .accordion-item').forEach((areaAccordion, index) => {
                const buildingId = areaAccordion.dataset.buildingId;
                const storageAreaCards = areaAccordion.querySelectorAll('.storage-areas > .card');
                const storageAreas = Array.from(storageAreaCards).map(card => {
                    const areaId = card.dataset.id || generateId();
                    let photos = [];
                    
                    // Get photos from preview container by reading the img src attributes
                    const photoPreview = card.querySelector(`[data-photos="storageArea_${areaId}"]`);
                    if (photoPreview) {
                        const photoItems = photoPreview.querySelectorAll('.photo-preview-item');
                        photos = Array.from(photoItems).map(item => {
                            const img = item.querySelector('img');
                            return img ? img.src : null;
                        }).filter(src => src !== null);
                    }
                    
                    return {
                        id: areaId,
                        name: card.querySelector('[data-field="storageAreaName"]')?.value || '',
                        access: {
                            stairs: card.querySelector('[data-field="accessStairs"]')?.checked || false,
                            elevator: card.querySelector('[data-field="accessElevator"]')?.checked || false,
                            loadingDock: card.querySelector('[data-field="accessLoadingDock"]')?.checked || false,
                            vehicle: card.querySelector('[data-field="accessVehicle"]')?.checked || false,
                            frontDoor: card.querySelector('[data-field="accessFrontDoor"]')?.checked || false,
                            sideDoor: card.querySelector('[data-field="accessSideDoor"]')?.checked || false,
                            rearDoor: card.querySelector('[data-field="accessRearDoor"]')?.checked || false
                        },
                        description: card.querySelector('[data-field="storageAreaDescription"]')?.value || '',
                        photos: photos
                    };
                });
                
                // Find the corresponding building and attach storage areas
                for (let site of currentAssessment.sites) {
                    for (let building of site.buildings) {
                        if (building.id === buildingId) {
                            building.storageAreas = storageAreas;
                            break;
                        }
                    }
                }
            });

            // Step 4: Collections (with merged container, media, and metadata)
            currentAssessment.collections = Array.from(document.querySelectorAll('#collectionsContainer > .accordion-item')).map(collEl => {
                const content = collEl.querySelector('.accordion-content');
                
                // Get container types
                const containerTypes = Array.from(content.querySelectorAll('.container-type-entry')).map(entry => {
                    const containerId = entry.dataset.id;
                    let containerPhotos = [];
                    let contentsPhotos = [];
                    
                    // Get photos from preview containers by reading the img src attributes
                    const containerPreview = entry.querySelector(`[data-photos="container_${containerId}"]`);
                    const contentsPreview = entry.querySelector(`[data-photos="contents_${containerId}"]`);
                    
                    if (containerPreview) {
                        const photoItems = containerPreview.querySelectorAll('.photo-preview-item');
                        containerPhotos = Array.from(photoItems).map(item => {
                            const img = item.querySelector('img');
                            return img ? img.src : null;
                        }).filter(src => src !== null);
                    }
                    
                    if (contentsPreview) {
                        const photoItems = contentsPreview.querySelectorAll('.photo-preview-item');
                        contentsPhotos = Array.from(photoItems).map(item => {
                            const img = item.querySelector('img');
                            return img ? img.src : null;
                        }).filter(src => src !== null);
                    }
                    
                    return {
                        type: entry.querySelector('[data-field="containerType"]').value,
                        otherDetails: entry.querySelector('[data-field="containerOtherDetails"]')?.value || '',
                        quantity: entry.querySelector('[data-field="containerQuantity"]').value,
                        dimensions: entry.querySelector('[data-field="containerDimensions"]').value,
                        condition: entry.querySelector('[data-field="containerCondition"]').value,
                        conditionNotes: entry.querySelector('[data-field="containerConditionNotes"]')?.value || '',
                        containerPhotos: containerPhotos,
                        contentsPhotos: contentsPhotos
                    };
                });

                // Get media types
                const mediaTypes = Array.from(content.querySelectorAll('.media-type-entry')).map(entry => ({
                    type: entry.querySelector('[data-field="mediaType"]').value,
                    format: entry.querySelector('[data-field="mediaFormat"]').value,
                    condition: entry.querySelector('[data-field="mediaCondition"]').value,
                    conditionNotes: entry.querySelector('[data-field="mediaConditionNotes"]')?.value || ''
                }));

                // Get metadata fields
                const metadataFields = Array.from(content.querySelectorAll('.metadata-field')).map((field, index) => ({
                    order: index + 1,
                    name: field.querySelector('[data-field="fieldName"]').value,
                    critical: field.querySelector('[data-field="fieldCritical"]').checked
                }));

                return {
                    id: collEl.dataset.id,
                    name: content.querySelector('[data-field="collectionName"]').value,
                    recordType: content.querySelector('[data-field="recordType"]').value,
                    storageArea: content.querySelector('[data-field="storageArea"]').value,
                    notes: content.querySelector('[data-field="collectionNotes"]').value,
                    containerTypes: containerTypes,
                    mediaTypes: mediaTypes,
                    metadataTemplate: content.querySelector('[data-field="metadataTemplate"]').value,
                    metadataFields: metadataFields
                };
            });

            currentAssessment.updatedAt = new Date().toISOString();
        }

        function populateForm() {
            // Step 1: Client & Contacts
            document.getElementById('clientName').value = currentAssessment.client.name || '';
            document.getElementById('clientInternalId').value = currentAssessment.client.internalId || '';
            document.getElementById('contactsContainer').innerHTML = '';
            if (currentAssessment.client.contacts && currentAssessment.client.contacts.length > 0) {
                currentAssessment.client.contacts.forEach(contact => addContact(contact));
            }

            // Step 2: Sites & Buildings
            document.getElementById('sitesContainer').innerHTML = '';
            if (currentAssessment.sites && currentAssessment.sites.length > 0) {
                currentAssessment.sites.forEach(site => {
                    addSite(site);
                });
            }

            // Steps 3-5 will be populated dynamically when user navigates to them
        }

        function saveDraft() {
            saveFormData();
            const index = assessments.findIndex(a => a.id === currentAssessment.id);
            if (index >= 0) {
                assessments[index] = currentAssessment;
            } else {
                assessments.push(currentAssessment);
            }
            localStorage.setItem('assessments', JSON.stringify(assessments));
            alert('Assessment saved as draft');
        }

        function markComplete() {
            saveFormData();
            currentAssessment.status = 'Complete';
            const index = assessments.findIndex(a => a.id === currentAssessment.id);
            if (index >= 0) {
                assessments[index] = currentAssessment;
            } else {
                assessments.push(currentAssessment);
            }
            localStorage.setItem('assessments', JSON.stringify(assessments));
            alert('Assessment marked as complete!');
        }

        // ========== Step 1: Contacts ==========
        function addContact(data = null) {
            const container = document.getElementById('contactsContainer');
            const html = `
                <div class="card contact-card">
                    <div class="card-header">
                        <h3>Contact</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name <span class="required">*</span></label>
                            <input type="text" data-field="contactFirstName" value="${escapeHtml(data?.firstName||'')}" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name <span class="required">*</span></label>
                            <input type="text" data-field="contactLastName" value="${escapeHtml(data?.lastName||'')}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Role/Title</label>
                        <input type="text" data-field="contactRole" value="${escapeHtml(data?.role||'')}">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" data-field="contactPhone" value="${escapeHtml(data?.phone||'')}" placeholder="XXX-XXX-XXXX" oninput="formatPhoneNumber(this)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" data-field="contactEmail" value="${escapeHtml(data?.email||'')}">
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd; text-align: center;">
                        <button type="button" class="btn btn-danger btn-small" onclick="removeElement(this)" style="width: auto; min-width: 120px;">üóëÔ∏è Remove Contact</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // ========== Step 2: Sites & Buildings ==========
        function addSite(data = null) {
            const stateOptions = US_STATES.map(s => 
                `<option value="${s.code}" ${data?.address?.state === s.code ? 'selected' : ''}>${s.code} - ${s.name}</option>`
            ).join('');
            
            const siteId = data?.id || generateId();
            const html = `
                <div class="accordion-item" data-id="${siteId}">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>Site: ${escapeHtml(data?.name || 'New Site')}</span>
                        <span class="accordion-toggle">‚ñº</span>
                    </div>
                    <div class="accordion-content ${data ? 'active' : ''}">
                        <div class="form-group">
                            <label>Site Name <span class="required">*</span></label>
                            <input type="text" data-field="siteName" value="${escapeHtml(data?.name||'')}" required onchange="updateAccordionTitle(this)">
                        </div>
                        <h4>Address</h4>
                        <div class="form-group">
                            <label>Street Address <span class="required">*</span></label>
                            <input type="text" data-field="siteStreetAddress" value="${escapeHtml(data?.address?.street||'')}" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City <span class="required">*</span></label>
                                <input type="text" data-field="siteCity" value="${escapeHtml(data?.address?.city||'')}" required>
                            </div>
                            <div class="form-group">
                                <label>State <span class="required">*</span></label>
                                <select data-field="siteState" required>
                                    <option value="">Select...</option>
                                    ${stateOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Zip Code <span class="required">*</span></label>
                                <input type="text" data-field="siteZipCode" value="${escapeHtml(data?.address?.zipCode||'')}" pattern="[0-9]{5}" required>
                            </div>
                        </div>
                        <h3>Buildings</h3>
                        <div class="buildings-container" data-site="${siteId}"></div>
                        <button type="button" class="btn btn-secondary" onclick="addBuilding('${siteId}')">+ Add Building</button><br><br>
                        <button type="button" class="btn btn-danger" onclick="removeElement(this)">Remove Site</button>
                    </div>
                </div>
            `;
            document.getElementById('sitesContainer').insertAdjacentHTML('beforeend', html);
            
            // Add buildings if data provided
            if (data?.buildings) {
                data.buildings.forEach(building => addBuilding(siteId, building));
            }
        }

        function addBuilding(siteId, data = null) {
            const buildingId = data?.id || generateId();
            const html = `
                <div class="card" data-id="${buildingId}">
                    <div class="card-header">
                        <h3>Building</h3>
                    </div>
                    <div class="form-group">
                        <label>Building Name <span class="required">*</span></label>
                        <input type="text" data-field="buildingName" value="${escapeHtml(data?.name||'')}" required>
                    </div>
                    <div class="form-group">
                        <label>Building Description</label>
                        <textarea data-field="buildingDescription">${escapeHtml(data?.description||'')}</textarea>
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd; text-align: center;">
                        <button type="button" class="btn btn-danger btn-small" onclick="removeElement(this)" style="width: auto; min-width: 120px;">üóëÔ∏è Remove Building</button>
                    </div>
                </div>
            `;
            document.querySelector(`[data-site="${siteId}"]`).insertAdjacentHTML('beforeend', html);
        }

        // ========== Step 3: Storage Areas ==========
        function renderStorageAreas() {
            saveFormData();
            const container = document.getElementById('storageAreasContainer');
            container.innerHTML = '';
            
            if (!currentAssessment.sites || currentAssessment.sites.length === 0) {
                container.innerHTML = '<p style="color:#e74c3c;">Please add sites and buildings in Step 2 first.</p>';
                return;
            }

            let hasBuildings = false;
            currentAssessment.sites.forEach(site => {
                site.buildings.forEach(building => {
                    hasBuildings = true;
                    const html = `
                        <div class="accordion-item" data-building-id="${building.id}">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <span>${escapeHtml(site.name)} - ${escapeHtml(building.name)}</span>
                                <span class="accordion-toggle">‚ñº</span>
                            </div>
                            <div class="accordion-content active">
                                <div class="storage-areas" data-building="${building.id}"></div>
                                <button type="button" class="btn btn-secondary" onclick="addStorageArea('${building.id}')">+ Add Storage Area</button>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                    
                    // Add existing storage areas
                    if (building.storageAreas && building.storageAreas.length > 0) {
                        building.storageAreas.forEach(area => {
                            addStorageArea(building.id, area);
                        });
                    }
                });
            });

            if (!hasBuildings) {
                container.innerHTML = '<p style="color:#e74c3c;">Please add buildings in Step 2 first.</p>';
            }
        }

        function addStorageArea(buildingId, data = null) {
            const container = document.querySelector(`[data-building="${buildingId}"]`);
            const areaId = data?.id || generateId();
            const html = `
                <div class="card" data-id="${areaId}">
                    <div class="card-header">
                        <h3>Storage Area</h3>
                    </div>
                    <div class="form-group">
                        <label>Storage Area Name <span class="required">*</span></label>
                        <input type="text" data-field="storageAreaName" value="${escapeHtml(data?.name||'')}" required>
                    </div>
                    <h4>Access Methods</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" data-field="accessStairs" ${data?.access?.stairs ? 'checked' : ''}> Stairs
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" data-field="accessElevator" ${data?.access?.elevator ? 'checked' : ''}> Elevator
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" data-field="accessLoadingDock" ${data?.access?.loadingDock ? 'checked' : ''}> Loading Dock
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" data-field="accessVehicle" ${data?.access?.vehicle ? 'checked' : ''}> Vehicle Access Nearby
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" data-field="accessFrontDoor" ${data?.access?.frontDoor ? 'checked' : ''}> Front Door
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" data-field="accessSideDoor" ${data?.access?.sideDoor ? 'checked' : ''}> Side Door
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" data-field="accessRearDoor" ${data?.access?.rearDoor ? 'checked' : ''}> Rear Door
                        </label>
                    </div>
                    <h4>Description / Comments / Concerns</h4>
                    <div class="form-group">
                        <textarea data-field="storageAreaDescription">${escapeHtml(data?.description||'')}</textarea>
                    </div>
                    <h4>Photos</h4>
                    <div class="form-group">
                        <input type="file" accept="image/*" capture="environment" data-field="storageAreaPhoto" onchange="handlePhotoUpload(this, 'storageArea_${areaId}')" style="display:none;" id="storagePhoto_${areaId}">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('storagePhoto_${areaId}').click()">üì∑ Take Photo</button>
                        <div class="photo-preview" data-photos="storageArea_${areaId}"></div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd; text-align: center;">
                        <button type="button" class="btn btn-danger btn-small" onclick="removeElement(this)" style="width: auto; min-width: 120px;">üóëÔ∏è Remove Storage Area</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            
            // If there are existing photos, display them after a brief delay to ensure DOM is ready
            if (data?.photos && data.photos.length > 0) {
                console.log('Loading', data.photos.length, 'existing photos for storage area:', areaId);
                setTimeout(() => {
                    const photoPreview = document.querySelector(`[data-photos="storageArea_${areaId}"]`);
                    if (photoPreview) {
                        console.log('Photo preview container found for restoration');
                        data.photos.forEach((photoSrc, index) => {
                            const photoId = generateId();
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-preview-item';
                            photoItem.dataset.photoId = photoId;
                            photoItem.innerHTML = `
                                <img src="${photoSrc}" alt="Storage Area Photo">
                                <button type="button" class="photo-remove" onclick="removePhoto('storageArea_${areaId}', '${photoId}')">√ó</button>
                            `;
                            photoPreview.appendChild(photoItem);
                            console.log('Restored photo', index + 1, 'of', data.photos.length);
                        });
                    } else {
                        console.error('Photo preview container not found for restoration:', 'storageArea_' + areaId);
                    }
                }, 100);
            }
        }

        // ========== Step 4: Collections (merged with containers, media, and metadata) ==========
        function getAllStorageAreas() {
            const storageAreas = [];
            if (currentAssessment.sites) {
                currentAssessment.sites.forEach(site => {
                    site.buildings.forEach(building => {
                        if (building.storageAreas) {
                            building.storageAreas.forEach(area => {
                                storageAreas.push({
                                    value: area.id,
                                    label: `${site.name} - ${building.name} - ${area.name}`
                                });
                            });
                        }
                    });
                });
            }
            return storageAreas;
        }

        function addCollection(data = null) {
            const collectionId = data?.id || generateId();
            const storageAreas = getAllStorageAreas();
            const storageAreaOptions = storageAreas.map(sa => 
                `<option value="${sa.value}" ${data?.storageArea === sa.value ? 'selected' : ''}>${escapeHtml(sa.label)}</option>`
            ).join('');

            const templateOptions = Object.keys(METADATA_TEMPLATES).map(t => 
                `<option ${data?.metadataTemplate === t ? 'selected' : ''}>${t}</option>`
            ).join('');

            const html = `
                <div class="accordion-item" data-id="${collectionId}">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>Collection: ${escapeHtml(data?.name || 'New Collection')}</span>
                        <span class="accordion-toggle">‚ñº</span>
                    </div>
                    <div class="accordion-content ${data ? 'active' : ''}">
                        <div class="form-group">
                            <label>Collection Name <span class="required">*</span></label>
                            <input type="text" data-field="collectionName" value="${escapeHtml(data?.name||'')}" required onchange="updateAccordionTitle(this)">
                        </div>
                        
                        <div class="form-group">
                            <label>Record Type</label>
                            <input type="text" data-field="recordType" value="${escapeHtml(data?.recordType||'')}" placeholder="e.g. Past Employee">
                        </div>

                        <div class="form-group">
                            <label>Storage Area</label>
                            <select data-field="storageArea">
                                <option value="">Select Storage Area...</option>
                                ${storageAreaOptions}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Notes</label>
                            <textarea data-field="collectionNotes">${escapeHtml(data?.notes||'')}</textarea>
                        </div>

                        <div class="section-divider"></div>

                        <!-- Container Types Section -->
                        <h3>Container Types</h3>
                        <div class="container-types-container" data-collection="${collectionId}"></div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addContainerType('${collectionId}')">+ Add Container Type</button>

                        <div class="section-divider"></div>

                        <!-- Media Types Section -->
                        <h3>Media Types</h3>
                        <div class="media-types-container" data-collection="${collectionId}"></div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addMediaType('${collectionId}')">+ Add Media Type</button>

                        <div class="section-divider"></div>

                        <!-- Metadata/Indexing Section -->
                        <h3>Metadata / Indexing</h3>
                        <div class="form-group">
                            <label>Template</label>
                            <select data-field="metadataTemplate" onchange="applyMetadataTemplate(this, '${collectionId}')">
                                ${templateOptions}
                            </select>
                        </div>
                        <h4>Metadata Fields</h4>
                        <div class="metadata-fields-container" data-collection="${collectionId}"></div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addMetadataField('${collectionId}')">+ Add Field</button>

                        <br><br>
                        <button type="button" class="btn btn-danger" onclick="removeElement(this)">Remove Collection</button>
                    </div>
                </div>
            `;
            document.getElementById('collectionsContainer').insertAdjacentHTML('beforeend', html);

            // Populate container types if data provided
            if (data?.containerTypes && data.containerTypes.length > 0) {
                data.containerTypes.forEach(container => addContainerType(collectionId, container));
            }

            // Populate media types if data provided
            if (data?.mediaTypes && data.mediaTypes.length > 0) {
                data.mediaTypes.forEach(media => addMediaType(collectionId, media));
            }

            // Populate metadata fields
            if (data?.metadataFields && data.metadataFields.length > 0) {
                data.metadataFields.forEach(field => addMetadataField(collectionId, field));
            } else if (data?.metadataTemplate && METADATA_TEMPLATES[data.metadataTemplate]) {
                METADATA_TEMPLATES[data.metadataTemplate].forEach(field => addMetadataField(collectionId, field));
            }
        }

        function addContainerType(collectionId, data = null) {
            const container = document.querySelector(`.container-types-container[data-collection="${collectionId}"]`);
            if (!container) {
                console.error('Container types container not found for collection:', collectionId);
                return;
            }
            const containerId = generateId();
            const showOther = data?.type === 'Other';
            
            const html = `
                <div class="card container-type-entry" data-id="${containerId}">
                    <div class="card-header">
                        <h4>Container Type</h4>
                    </div>
                    <div class="form-group">
                        <label>Container Type <span class="required">*</span></label>
                        <select data-field="containerType" required onchange="toggleContainerOther(this)">
                            <option value="">Select...</option>
                            <option ${data?.type === 'Bankers Box' ? 'selected' : ''}>Bankers Box</option>
                            <option ${data?.type === 'Tall Filing Cabinet drawer' ? 'selected' : ''}>Tall Filing Cabinet drawer</option>
                            <option ${data?.type === 'Wide Filing Cabinet drawer' ? 'selected' : ''}>Wide Filing Cabinet drawer</option>
                            <option ${data?.type === 'Storage Box' ? 'selected' : ''}>Storage Box</option>
                            <option ${data?.type === 'Binder' ? 'selected' : ''}>Binder</option>
                            <option ${data?.type === 'Carton' ? 'selected' : ''}>Carton</option>
                            <option ${data?.type === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group container-other-field ${showOther ? '' : 'hidden'}">
                        <label>Other Container Details</label>
                        <input type="text" data-field="containerOtherDetails" value="${escapeHtml(data?.otherDetails||'')}" placeholder="Describe the container type">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" data-field="containerQuantity" value="${data?.quantity||''}">
                        </div>
                        <div class="form-group">
                            <label>Dimensions</label>
                            <input type="text" data-field="containerDimensions" value="${escapeHtml(data?.dimensions||'')}" placeholder="e.g., 12x15x10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <select data-field="containerCondition" onchange="toggleConditionNotes(this)">
                            <option ${data?.condition === 'Excellent' ? 'selected' : ''}>Excellent</option>
                            <option ${data?.condition === 'Good' ? 'selected' : ''}>Good</option>
                            <option ${data?.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                            <option ${data?.condition === 'Poor' ? 'selected' : ''}>Poor</option>
                        </select>
                    </div>
                    <div class="form-group condition-notes-field ${(data?.condition === 'Fair' || data?.condition === 'Poor') ? '' : 'hidden'}">
                        <label>Notes</label>
                        <textarea data-field="containerConditionNotes" placeholder="Describe the condition issues...">${escapeHtml(data?.conditionNotes||'')}</textarea>
                    </div>
                    <h4>Photos</h4>
                    <div class="form-group">
                        <label>Container Photos</label>
                        <input type="file" accept="image/*" capture="environment" onchange="handlePhotoUpload(this, 'container_${containerId}')" style="display:none;" id="containerPhoto_${containerId}">
                        <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('containerPhoto_${containerId}').click()">üì∑ Take Photo of Container</button>
                        <div class="photo-preview" data-photos="container_${containerId}"></div>
                    </div>
                    <div class="form-group">
                        <label>Contents Photos</label>
                        <input type="file" accept="image/*" capture="environment" onchange="handlePhotoUpload(this, 'contents_${containerId}')" style="display:none;" id="contentsPhoto_${containerId}">
                        <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('contentsPhoto_${containerId}').click()">üì∑ Take Photo of Contents</button>
                        <div class="photo-preview" data-photos="contents_${containerId}"></div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd; text-align: center;">
                        <button type="button" class="btn btn-danger btn-small" onclick="removeElement(this)" style="width: auto; min-width: 120px;">üóëÔ∏è Remove Container</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            
            // If there are existing photos, display them after a brief delay to ensure DOM is ready
            if (data?.containerPhotos && data.containerPhotos.length > 0) {
                console.log('Loading', data.containerPhotos.length, 'container photos for:', containerId);
                setTimeout(() => {
                    const containerPreview = document.querySelector(`[data-photos="container_${containerId}"]`);
                    if (containerPreview) {
                        console.log('Container photo preview found for restoration');
                        data.containerPhotos.forEach((photoSrc, index) => {
                            const photoId = generateId();
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-preview-item';
                            photoItem.dataset.photoId = photoId;
                            photoItem.innerHTML = `
                                <img src="${photoSrc}" alt="Container Photo">
                                <button type="button" class="photo-remove" onclick="removePhoto('container_${containerId}', '${photoId}')">√ó</button>
                            `;
                            containerPreview.appendChild(photoItem);
                            console.log('Restored container photo', index + 1, 'of', data.containerPhotos.length);
                        });
                    } else {
                        console.error('Container photo preview not found for restoration');
                    }
                }, 100);
            }
            
            if (data?.contentsPhotos && data.contentsPhotos.length > 0) {
                console.log('Loading', data.contentsPhotos.length, 'contents photos for:', containerId);
                setTimeout(() => {
                    const contentsPreview = document.querySelector(`[data-photos="contents_${containerId}"]`);
                    if (contentsPreview) {
                        console.log('Contents photo preview found for restoration');
                        data.contentsPhotos.forEach((photoSrc, index) => {
                            const photoId = generateId();
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-preview-item';
                            photoItem.dataset.photoId = photoId;
                            photoItem.innerHTML = `
                                <img src="${photoSrc}" alt="Contents Photo">
                                <button type="button" class="photo-remove" onclick="removePhoto('contents_${containerId}', '${photoId}')">√ó</button>
                            `;
                            contentsPreview.appendChild(photoItem);
                            console.log('Restored contents photo', index + 1, 'of', data.contentsPhotos.length);
                        });
                    } else {
                        console.error('Contents photo preview not found for restoration');
                    }
                }, 100);
            }
        }

        function toggleContainerOther(select) {
            const card = select.closest('.container-type-entry');
            const otherField = card.querySelector('.container-other-field');
            if (select.value === 'Other') {
                otherField.classList.remove('hidden');
            } else {
                otherField.classList.add('hidden');
            }
        }

        function toggleConditionNotes(select) {
            const card = select.closest('.card');
            const notesField = card.querySelector('.condition-notes-field');
            if (notesField) {
                if (select.value === 'Fair' || select.value === 'Poor') {
                    notesField.classList.remove('hidden');
                } else {
                    notesField.classList.add('hidden');
                }
            }
        }

        function addMediaType(collectionId, data = null) {
            const container = document.querySelector(`.media-types-container[data-collection="${collectionId}"]`);
            if (!container) {
                console.error('Media types container not found for collection:', collectionId);
                return;
            }
            const mediaId = generateId();
            
            const html = `
                <div class="card media-type-entry" data-id="${mediaId}">
                    <div class="card-header">
                        <h4>Media Type</h4>
                    </div>
                    <div class="form-group">
                        <label>Media Type <span class="required">*</span></label>
                        <select data-field="mediaType" required>
                            <option value="">Select...</option>
                            <option ${data?.type === 'Paper Documents' ? 'selected' : ''}>Paper Documents</option>
                            <option ${data?.type === 'Blueprints/Plans' ? 'selected' : ''}>Blueprints/Plans</option>
                            <option ${data?.type === 'Photographs' ? 'selected' : ''}>Photographs</option>
                            <option ${data?.type === 'VHS Tapes' ? 'selected' : ''}>VHS Tapes</option>
                            <option ${data?.type === 'Audio Cassettes' ? 'selected' : ''}>Audio Cassettes</option>
                            <option ${data?.type === 'CDs/DVDs' ? 'selected' : ''}>CDs/DVDs</option>
                            <option ${data?.type === 'Microfilm/Microfiche' ? 'selected' : ''}>Microfilm/Microfiche</option>
                            <option ${data?.type === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Format/Size</label>
                            <input type="text" data-field="mediaFormat" value="${escapeHtml(data?.format||'')}" placeholder="e.g., 8.5x11, 24x36">
                        </div>
                        <div class="form-group">
                            <label>Condition</label>
                            <select data-field="mediaCondition" onchange="toggleConditionNotes(this)">
                                <option ${data?.condition === 'Excellent' ? 'selected' : ''}>Excellent</option>
                                <option ${data?.condition === 'Good' ? 'selected' : ''}>Good</option>
                                <option ${data?.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                                <option ${data?.condition === 'Poor' ? 'selected' : ''}>Poor</option>
                                <option ${data?.condition === 'Damaged' ? 'selected' : ''}>Damaged</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group condition-notes-field ${(data?.condition === 'Fair' || data?.condition === 'Poor') ? '' : 'hidden'}">
                        <label>Notes</label>
                        <textarea data-field="mediaConditionNotes" placeholder="Describe the condition issues...">${escapeHtml(data?.conditionNotes||'')}</textarea>
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd; text-align: center;">
                        <button type="button" class="btn btn-danger btn-small" onclick="removeElement(this)" style="width: auto; min-width: 120px;">üóëÔ∏è Remove Media Type</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function applyMetadataTemplate(select, collectionId) {
            const template = select.value;
            const container = document.querySelector(`.metadata-fields-container[data-collection="${collectionId}"]`);
            if (!container) {
                console.error('Metadata fields container not found for collection:', collectionId);
                return;
            }
            container.innerHTML = '';
            
            if (METADATA_TEMPLATES[template]) {
                METADATA_TEMPLATES[template].forEach(field => addMetadataField(collectionId, field));
            }
        }

        function addMetadataField(collectionId, data = null) {
            const container = document.querySelector(`.metadata-fields-container[data-collection="${collectionId}"]`);
            if (!container) {
                console.error('Metadata fields container not found for collection:', collectionId);
                return;
            }
            const order = container.children.length + 1;
            const html = `
                <div class="metadata-field">
                    <div class="metadata-field-order">${order}</div>
                    <div class="metadata-field-inputs">
                        <input type="text" data-field="fieldName" value="${escapeHtml(data?.name||'')}" placeholder="Field Name" required>
                        <label class="checkbox-item">
                            <input type="checkbox" data-field="fieldCritical" ${data?.critical ? 'checked' : ''}> Critical Field
                        </label>
                    </div>
                    <div class="metadata-field-controls">
                        <button type="button" class="btn btn-secondary btn-small" onclick="moveMetadataField(this, 'up')">‚Üë</button>
                        <button type="button" class="btn btn-secondary btn-small" onclick="moveMetadataField(this, 'down')">‚Üì</button>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeMetadataField(this)">√ó</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function moveMetadataField(btn, direction) {
            const field = btn.closest('.metadata-field');
            const sibling = direction === 'up' ? field.previousElementSibling : field.nextElementSibling;
            if (sibling) {
                if (direction === 'up') {
                    field.parentNode.insertBefore(field, sibling);
                } else {
                    field.parentNode.insertBefore(sibling, field);
                }
                renumberMetadataFields(field.parentNode);
            }
        }

        function removeMetadataField(btn) {
            const field = btn.closest('.metadata-field');
            const container = field.parentNode;
            field.remove();
            renumberMetadataFields(container);
        }

        function renumberMetadataFields(container) {
            container.querySelectorAll('.metadata-field').forEach((field, index) => {
                field.querySelector('.metadata-field-order').textContent = index + 1;
            });
        }

        // ========== Step 5: Review ==========
        function renderReview() {
            saveFormData();
            
            let html = `<div class="review-section">
                <h3>Assessment Summary</h3>
                <div class="card">
                    <p><strong>Company Name:</strong> ${escapeHtml(currentAssessment.client.name||'N/A')}</p>
                    <p><strong>Internal Company ID:</strong> ${escapeHtml(currentAssessment.client.internalId||'N/A')}</p>
                    <p><strong>Status:</strong> ${currentAssessment.status}</p>
                    <p><strong>Created:</strong> ${new Date(currentAssessment.createdAt).toLocaleString()}</p>
                    <p><strong>Last Modified:</strong> ${new Date(currentAssessment.updatedAt).toLocaleString()}</p>
                </div>
            </div>`;

            // Contacts
            html += `<div class="review-section">
                <h3>Contacts (${currentAssessment.client.contacts.length})</h3>
                <table class="review-table">
                    <thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Phone</th></tr></thead>
                    <tbody>`;
            currentAssessment.client.contacts.forEach(c => {
                html += `<tr>
                    <td>${escapeHtml(c.firstName)} ${escapeHtml(c.lastName)}</td>
                    <td>${escapeHtml(c.role||'-')}</td>
                    <td>${escapeHtml(c.email||'-')}</td>
                    <td>${escapeHtml(c.phone||'-')}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;

            // Sites & Buildings
            html += `<div class="review-section">
                <h3>Sites & Buildings (${currentAssessment.sites.length} sites)</h3>`;
            currentAssessment.sites.forEach(site => {
                html += `<div class="card">
                    <h4>${escapeHtml(site.name)}</h4>
                    <p>${escapeHtml(site.address.street)}, ${escapeHtml(site.address.city)}, ${site.address.state} ${site.address.zipCode}</p>
                    <p><strong>Buildings:</strong> ${site.buildings.length}</p>
                    <ul>`;
                site.buildings.forEach(b => {
                    html += `<li>${escapeHtml(b.name)} - ${b.storageAreas?.length || 0} storage areas</li>`;
                });
                html += `</ul></div>`;
            });
            html += `</div>`;

            // Collections
            html += `<div class="review-section">
                <h3>Collections (${currentAssessment.collections.length})</h3>`;
            currentAssessment.collections.forEach(coll => {
                html += `<div class="card">
                    <h4>${escapeHtml(coll.name)}</h4>
                    <p><strong>Type:</strong> ${escapeHtml(coll.recordType||'N/A')}</p>
                    <p><strong>Container Types:</strong> ${coll.containerTypes?.length || 0}</p>
                    <p><strong>Media Types:</strong> ${coll.mediaTypes?.length || 0}</p>
                    <p><strong>Metadata Fields:</strong> ${coll.metadataFields?.length || 0} (${coll.metadataFields?.filter(f => f.critical).length || 0} critical)</p>
                </div>`;
            });
            html += `</div>`;

            document.getElementById('reviewContainer').innerHTML = html;
        }

        // ========== Dynamic Content Rendering ==========
        function renderDynamicContent() {
            if (currentStep === 3) {
                renderStorageAreas();
            } else if (currentStep === 4 && currentAssessment.collections.length > 0) {
                document.getElementById('collectionsContainer').innerHTML = '';
                currentAssessment.collections.forEach(coll => addCollection(coll));
            } else if (currentStep === 5) {
                renderReview();
            }
        }

        // ========== Photo Upload Handling ==========
        function handlePhotoUpload(input, photoGroupId) {
            console.log('handlePhotoUpload called with photoGroupId:', photoGroupId);
            
            const file = input.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);
            
            // Check if it's an image
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoData = e.target.result;
                console.log('Photo data loaded, length:', photoData.length);
                
                const previewContainer = document.querySelector(`[data-photos="${photoGroupId}"]`);
                console.log('Looking for preview container with data-photos:', photoGroupId);
                console.log('Preview container found:', previewContainer);
                
                if (!previewContainer) {
                    console.error('Preview container not found for:', photoGroupId);
                    console.log('Available preview containers:', Array.from(document.querySelectorAll('[data-photos]')).map(el => el.getAttribute('data-photos')));
                    alert('Error: Could not find photo preview area. Please try again or contact support.');
                    return;
                }
                
                // Create unique photo ID
                const photoId = generateId();
                console.log('Generated photo ID:', photoId);
                
                // Create preview element
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-preview-item';
                photoItem.dataset.photoId = photoId;
                photoItem.dataset.photoData = photoData; // Store the data directly
                photoItem.innerHTML = `
                    <img src="${photoData}" alt="Photo">
                    <button type="button" class="photo-remove" onclick="removePhoto('${photoGroupId}', '${photoId}')">√ó</button>
                `;
                
                previewContainer.appendChild(photoItem);
                console.log('Photo preview added successfully');
                
                // Show success message
                const imgElement = photoItem.querySelector('img');
                imgElement.onload = function() {
                    console.log('Photo image loaded and displayed');
                };
            };
            
            reader.onerror = function(error) {
                console.error('Error reading file:', error);
                alert('Error uploading photo. Please try again.');
            };
            
            reader.readAsDataURL(file);
            
            // Reset input so same file can be selected again
            input.value = '';
        }
        
        function removePhoto(photoGroupId, photoId) {
            console.log('removePhoto called for:', photoGroupId, photoId);
            
            if (!confirm('Remove this photo?')) return;
            
            const previewContainer = document.querySelector(`[data-photos="${photoGroupId}"]`);
            if (!previewContainer) {
                console.error('Preview container not found');
                return;
            }
            
            // Remove from DOM
            const photoItem = previewContainer.querySelector(`[data-photo-id="${photoId}"]`);
            if (photoItem) {
                photoItem.remove();
                console.log('Photo removed successfully from:', photoGroupId);
            } else {
                console.error('Photo item not found:', photoId);
            }
        }

        // ========== Utility Functions ==========
        function formatPhoneNumber(input) {
            // Remove all non-numeric characters
            let value = input.value.replace(/\D/g, '');
            
            // Limit to 10 digits
            value = value.substring(0, 10);
            
            // Format as XXX-XXX-XXXX
            if (value.length >= 6) {
                input.value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6);
            } else if (value.length >= 3) {
                input.value = value.substring(0, 3) + '-' + value.substring(3);
            } else {
                input.value = value;
            }
        }

        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.accordion-toggle');
            content.classList.toggle('active');
            toggle.classList.toggle('active');
        }

        function removeElement(btn) {
            if (confirm('Remove this item?')) {
                const element = btn.closest('.card') || btn.closest('.accordion-item');
                if (element) {
                    element.remove();
                }
            }
        }

        function updateAccordionTitle(input) {
            const accordion = input.closest('.accordion-item');
            if (accordion) {
                const header = accordion.querySelector('.accordion-header span:first-child');
                const prefix = header.textContent.split(':')[0];
                header.textContent = `${prefix}: ${input.value || 'New'}`;
            }
        }

        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== Export Functions ==========
        function exportToExcel() {
            saveFormData();
            generateExcel(currentAssessment);
        }

        function exportAssessmentToExcel(id) {
            const assessment = assessments.find(a => a.id === id);
            if (assessment) generateExcel(assessment);
        }

        function generateExcel(assessment) {
            const wb = XLSX.utils.book_new();
            
            // Summary Sheet
            const summaryData = [
                ['Assessment ID', 'Company Name', 'Internal Company ID', 'Created Date', 'Modified Date', 'Status'],
                [
                    assessment.id,
                    assessment.client.name,
                    assessment.client.internalId || '',
                    new Date(assessment.createdAt).toLocaleDateString(),
                    new Date(assessment.updatedAt).toLocaleDateString(),
                    assessment.status
                ]
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), 'Summary');
            
            // Contacts Sheet
            const contactsData = [['Assessment ID', 'Company Name', 'First Name', 'Last Name', 'Role', 'Phone', 'Email']];
            assessment.client.contacts?.forEach(c => {
                contactsData.push([
                    assessment.id,
                    assessment.client.name,
                    c.firstName || '',
                    c.lastName || '',
                    c.role || '',
                    c.phone || '',
                    c.email || ''
                ]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(contactsData), 'Contacts');
            
            // Locations Sheet
            const locationsData = [['Assessment ID', 'Company Name', 'Site Name', 'Street', 'City', 'State', 'Zip', 'Building Name', 'Building Description']];
            assessment.sites?.forEach(site => {
                site.buildings?.forEach(building => {
                    locationsData.push([
                        assessment.id,
                        assessment.client.name,
                        site.name,
                        site.address.street,
                        site.address.city,
                        site.address.state,
                        site.address.zipCode,
                        building.name,
                        building.description || ''
                    ]);
                });
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(locationsData), 'Locations');
            
            // Storage Areas Sheet
            const storageData = [['Assessment ID', 'Site', 'Building', 'Storage Area', 'Stairs', 'Elevator', 'Loading Dock', 'Vehicle Access', 'Front Door', 'Side Door', 'Rear Door', 'Description']];
            assessment.sites?.forEach(site => {
                site.buildings?.forEach(building => {
                    building.storageAreas?.forEach(area => {
                        storageData.push([
                            assessment.id,
                            site.name,
                            building.name,
                            area.name,
                            area.access?.stairs ? 'Yes' : 'No',
                            area.access?.elevator ? 'Yes' : 'No',
                            area.access?.loadingDock ? 'Yes' : 'No',
                            area.access?.vehicle ? 'Yes' : 'No',
                            area.access?.frontDoor ? 'Yes' : 'No',
                            area.access?.sideDoor ? 'Yes' : 'No',
                            area.access?.rearDoor ? 'Yes' : 'No',
                            area.description || ''
                        ]);
                    });
                });
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(storageData), 'Storage Areas');
            
            // Collections Sheet
            const collectionsData = [['Assessment ID', 'Company Name', 'Collection Name', 'Record Type', 'Storage Area', 'Notes']];
            assessment.collections?.forEach(coll => {
                // Get storage area name
                let storageAreaName = '';
                if (coll.storageArea) {
                    assessment.sites?.forEach(site => {
                        site.buildings?.forEach(building => {
                            building.storageAreas?.forEach(area => {
                                if (area.id === coll.storageArea) {
                                    storageAreaName = `${site.name} - ${building.name} - ${area.name}`;
                                }
                            });
                        });
                    });
                }
                
                collectionsData.push([
                    assessment.id,
                    assessment.client.name,
                    coll.name,
                    coll.recordType || '',
                    storageAreaName,
                    coll.notes || ''
                ]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(collectionsData), 'Collections');
            
            // Containers Sheet
            const containersData = [['Assessment ID', 'Company Name', 'Collection', 'Container Type', 'Other Details', 'Quantity', 'Dimensions', 'Condition']];
            assessment.collections?.forEach(coll => {
                coll.containerTypes?.forEach(c => {
                    containersData.push([
                        assessment.id,
                        assessment.client.name,
                        coll.name,
                        c.type,
                        c.otherDetails || '',
                        c.quantity || '',
                        c.dimensions || '',
                        c.condition || ''
                    ]);
                });
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(containersData), 'Containers');
            
            // Media Sheet
            const mediaData = [['Assessment ID', 'Company Name', 'Collection', 'Media Type', 'Format', 'Condition']];
            assessment.collections?.forEach(coll => {
                coll.mediaTypes?.forEach(m => {
                    mediaData.push([
                        assessment.id,
                        assessment.client.name,
                        coll.name,
                        m.type,
                        m.format || '',
                        m.condition || ''
                    ]);
                });
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(mediaData), 'Media');
            
            // Metadata Fields Sheet
            const metadataData = [['Assessment ID', 'Company Name', 'Collection', 'Template', 'Field Order', 'Field Name', 'Critical']];
            assessment.collections?.forEach(coll => {
                coll.metadataFields?.forEach(field => {
                    metadataData.push([
                        assessment.id,
                        assessment.client.name,
                        coll.name,
                        coll.metadataTemplate || '',
                        field.order,
                        field.name,
                        field.critical ? 'Yes' : 'No'
                    ]);
                });
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(metadataData), 'Metadata Fields');
            
            const fileName = `Assessment_${assessment.client.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function exportToJSON() {
            saveFormData();
            const dataStr = JSON.stringify(currentAssessment, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Assessment_${currentAssessment.client.name.replace(/[^a-z0-9]/gi, '_')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function sendAssessmentViaEmail() {
            saveFormData();
            
            if (!currentAssessment.client.name) {
                showMobileMessage('‚ö†Ô∏è Error', 'Please complete the assessment before sending via email.', 'error');
                return;
            }
            
            console.log('Starting email export process...');
            
            // Show loading message
            showMobileMessage('üì¶ Preparing Files...', 'Generating Excel file and downloading photos. Please wait...', 'info');
            
            // Create email content
            const companyName = currentAssessment.client.name;
            const subject = `Records Assessment - ${companyName}`;
            
            // Export Excel first
            generateExcel(currentAssessment);
            console.log('Excel file downloaded');
            
            // Download photos
            const photoCount = downloadAllPhotos();
            console.log('Photos downloaded');
            
            // Show iOS-specific instructions after downloads complete
            setTimeout(() => {
                const filesInfo = photoCount > 0 
                    ? `‚úÖ Downloaded:\n‚Ä¢ 1 Excel file\n‚Ä¢ ${photoCount} photo(s)` 
                    : `‚úÖ Downloaded:\n‚Ä¢ 1 Excel file\n‚Ä¢ No photos`;
                
                const body = `Assessment Details:
- Company: ${companyName}
- Status: ${currentAssessment.status}
- Created: ${new Date(currentAssessment.createdAt).toLocaleDateString()}
- Last Modified: ${new Date(currentAssessment.updatedAt).toLocaleDateString()}

Please find the Records Assessment files for ${companyName}.`;
                
                // Show instructions modal
                const instructionsHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" id="emailInstructionsModal" onclick="document.getElementById('emailInstructionsModal').remove()">
                        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h2 style="color: #27ae60; margin-bottom: 20px; font-size: 24px;">üìß Files Ready!</h2>
                            
                            <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #27ae60;">
                                <p style="margin: 0; font-size: 16px; white-space: pre-line;">${filesInfo}</p>
                            </div>
                            
                            <h3 style="color: #333; font-size: 18px; margin-bottom: 15px;">üì± On iPhone - How to Attach Files:</h3>
                            
                            <ol style="padding-left: 20px; line-height: 1.8; font-size: 15px;">
                                <li style="margin-bottom: 12px;"><strong>Tap the Download icon</strong> (‚¨áÔ∏è) in Safari's address bar (top of screen)</li>
                                <li style="margin-bottom: 12px;"><strong>You'll see your files listed</strong> - the Excel file and photos</li>
                                <li style="margin-bottom: 12px;"><strong>Tap on each file</strong> to open it</li>
                                <li style="margin-bottom: 12px;"><strong>Tap the Share button</strong> (square with arrow)</li>
                                <li style="margin-bottom: 12px;"><strong>Choose "Mail"</strong> to attach to email</li>
                                <li style="margin-bottom: 12px;"><strong>Repeat for all files</strong> (Excel + photos)</li>
                            </ol>
                            
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px solid #ffc107;">
                                <p style="margin: 0; font-size: 14px;"><strong>üí° Tip:</strong> Files are in Safari Downloads. Look for the blue download icon (‚¨áÔ∏è) next to the address bar.</p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 25px;">
                                <button onclick="openMailClient('${encodeURIComponent(subject)}', '${encodeURIComponent(body)}'); document.getElementById('emailInstructionsModal').remove();" style="flex: 1; background: #3498db; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: 600;">
                                    Open Email App
                                </button>
                                <button onclick="document.getElementById('emailInstructionsModal').remove()" style="flex: 1; background: #95a5a6; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: 600;">
                                    Close
                                </button>
                            </div>
                            
                            <p style="margin-top: 20px; font-size: 13px; color: #666; text-align: center;">Tap outside to close</p>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', instructionsHTML);
                
                console.log('Email instructions displayed');
            }, 1000);
        }
        
        function openMailClient(subject, body) {
            try {
                const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
                window.location.href = mailtoLink;
                console.log('Email client opened');
            } catch (error) {
                console.error('Error opening email client:', error);
            }
        }
        
        function showMobileMessage(title, message, type) {
            const bgColor = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db';
            const html = `
                <div style="position: fixed; top: 20px; left: 20px; right: 20px; background: ${bgColor}; color: white; padding: 20px; border-radius: 12px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideDown 0.3s;" id="mobileMessage">
                    <h3 style="margin: 0 0 10px 0; font-size: 18px;">${title}</h3>
                    <p style="margin: 0; font-size: 15px;">${message}</p>
                </div>
                <style>
                    @keyframes slideDown {
                        from { transform: translateY(-100px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            setTimeout(() => {
                const msg = document.getElementById('mobileMessage');
                if (msg) msg.remove();
            }, 3000);
        }

        function downloadAllPhotos() {
            let photoCount = 0;
            const timestamp = new Date().toISOString().split('T')[0];
            const companyName = currentAssessment.client.name.replace(/[^a-z0-9]/gi, '_');
            
            // Download storage area photos
            if (currentAssessment.sites) {
                currentAssessment.sites.forEach(site => {
                    site.buildings?.forEach(building => {
                        building.storageAreas?.forEach(area => {
                            if (area.photos && area.photos.length > 0) {
                                area.photos.forEach((photoSrc, index) => {
                                    photoCount++;
                                    downloadPhoto(photoSrc, `${companyName}_StorageArea_${area.name.replace(/[^a-z0-9]/gi, '_')}_${index + 1}_${timestamp}.png`);
                                });
                            }
                        });
                    });
                });
            }
            
            // Download container and contents photos
            if (currentAssessment.collections) {
                currentAssessment.collections.forEach(collection => {
                    collection.containerTypes?.forEach((container, containerIndex) => {
                        if (container.containerPhotos && container.containerPhotos.length > 0) {
                            container.containerPhotos.forEach((photoSrc, index) => {
                                photoCount++;
                                downloadPhoto(photoSrc, `${companyName}_Container_${collection.name.replace(/[^a-z0-9]/gi, '_')}_${containerIndex + 1}_${index + 1}_${timestamp}.png`);
                            });
                        }
                        if (container.contentsPhotos && container.contentsPhotos.length > 0) {
                            container.contentsPhotos.forEach((photoSrc, index) => {
                                photoCount++;
                                downloadPhoto(photoSrc, `${companyName}_Contents_${collection.name.replace(/[^a-z0-9]/gi, '_')}_${containerIndex + 1}_${index + 1}_${timestamp}.png`);
                            });
                        }
                    });
                });
            }
            
            if (photoCount === 0) {
                console.log('No photos to download');
            } else {
                console.log(`Downloaded ${photoCount} photos`);
            }
            
            return photoCount;
        }

        function downloadPhoto(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importAssessment(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    imported.id = generateId();
                    imported.createdAt = new Date().toISOString();
                    imported.updatedAt = new Date().toISOString();
                    assessments.push(imported);
                    localStorage.setItem('assessments', JSON.stringify(assessments));
                    renderAssessmentList();
                    alert('Assessment imported successfully!');
                } catch (err) {
                    alert('Error importing assessment: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ========== SECURE OneDrive Integration with PKCE ==========
        
        // OneDrive Configuration (NO SECRET - SECURE!)
        const ONEDRIVE_CONFIG = {
            clientId: 'be0160e5-8140-4e87-92cb-cd11b4d0d677',
            tenantId: 'common',
            redirectUri: window.location.origin + window.location.pathname,  // Dynamic - redirects back to current file
            scopes: 'Files.ReadWrite.AppFolder offline_access User.Read'
        };

        // OneDrive State
        let oneDriveToken = localStorage.getItem('onedrive_token');
        let oneDriveRefreshToken = localStorage.getItem('onedrive_refresh_token');
        let oneDriveUserEmail = localStorage.getItem('onedrive_user_email');
        let oneDriveFolder = localStorage.getItem('onedrive_folder') || '/Assessments/';

        // Initialize OneDrive status on load
        window.addEventListener('load', () => {
            updateCloudStatus();
            checkOneDriveCallback();
        });

        // ========== PKCE Helper Functions ==========
        
        // Generate random string for code verifier
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        // Create code challenge from verifier
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(digest));
        }

        // Base64 URL encoding (RFC 4648)
        function base64URLEncode(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // Generate random state parameter
        function generateState() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        // ========== OAuth PKCE Flow ==========
        
        // Connect to OneDrive using PKCE
        async function connectOneDrive() {
            // Generate PKCE parameters
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const state = generateState();
            
            // Store verifier and state for callback
            sessionStorage.setItem('pkce_code_verifier', codeVerifier);
            sessionStorage.setItem('pkce_state', state);
            
            // Build authorization URL with prompt=consent to force permission screen
            const authUrl = `https://login.microsoftonline.com/${ONEDRIVE_CONFIG.tenantId}/oauth2/v2.0/authorize?` +
                `client_id=${ONEDRIVE_CONFIG.clientId}` +
                `&response_type=code` +
                `&redirect_uri=${encodeURIComponent(ONEDRIVE_CONFIG.redirectUri)}` +
                `&scope=${encodeURIComponent(ONEDRIVE_CONFIG.scopes)}` +
                `&state=${state}` +
                `&code_challenge=${codeChallenge}` +
                `&code_challenge_method=S256` +
                `&response_mode=query` +
                `&prompt=consent`;  // Force consent screen to appear
            
            console.log('Authorization URL:', authUrl);
            console.log('Requesting scopes:', ONEDRIVE_CONFIG.scopes);
            
            // Redirect to Microsoft login
            window.location.href = authUrl;
        }

        // Check if returning from OAuth callback
        async function checkOneDriveCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            // Handle error
            if (error) {
                console.error('OAuth error:', error, urlParams.get('error_description'));
                const errorDesc = urlParams.get('error_description') || '';
                
                // Check if it's a redirect_uri error
                if (errorDesc.includes('redirect_uri') || error === 'invalid_request') {
                    showMobileMessage(
                        '‚ö†Ô∏è Setup Required', 
                        'Redirect URI not registered. Tap the ‚òÅÔ∏è icon ‚Üí Settings ‚Üí Setup Helper for instructions.', 
                        'error'
                    );
                } else {
                    showMobileMessage('‚ö†Ô∏è Connection Failed', 'Could not connect to OneDrive. Please try again.', 'error');
                }
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            // Handle successful authorization
            if (code && state) {
                const storedState = sessionStorage.getItem('pkce_state');
                const codeVerifier = sessionStorage.getItem('pkce_code_verifier');
                
                // Verify state to prevent CSRF
                if (state !== storedState) {
                    console.error('State mismatch - possible CSRF attack');
                    showMobileMessage('‚ö†Ô∏è Security Error', 'Authentication failed. Please try again.', 'error');
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                
                // Exchange code for token
                showMobileMessage('üîê Connecting...', 'Completing secure authentication...', 'info');
                
                try {
                    await exchangeCodeForToken(code, codeVerifier);
                    showMobileMessage('‚úÖ Connected!', 'OneDrive connected successfully!', 'success');
                } catch (error) {
                    console.error('Token exchange failed:', error);
                    showMobileMessage('‚ö†Ô∏è Error', 'Failed to complete authentication. Please try again.', 'error');
                }
                
                // Clean up
                sessionStorage.removeItem('pkce_code_verifier');
                sessionStorage.removeItem('pkce_state');
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Exchange authorization code for access token (PKCE)
        async function exchangeCodeForToken(code, codeVerifier) {
            const tokenUrl = `https://login.microsoftonline.com/${ONEDRIVE_CONFIG.tenantId}/oauth2/v2.0/token`;
            
            const body = new URLSearchParams({
                client_id: ONEDRIVE_CONFIG.clientId,
                scope: ONEDRIVE_CONFIG.scopes,
                code: code,
                redirect_uri: ONEDRIVE_CONFIG.redirectUri,
                grant_type: 'authorization_code',
                code_verifier: codeVerifier  // PKCE parameter - NO SECRET NEEDED!
            });
            
            const response = await fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body.toString()
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Token exchange failed: ${response.status} - ${error}`);
            }
            
            const data = await response.json();
            
            // Store tokens
            oneDriveToken = data.access_token;
            oneDriveRefreshToken = data.refresh_token;
            
            localStorage.setItem('onedrive_token', data.access_token);
            localStorage.setItem('onedrive_refresh_token', data.refresh_token);
            localStorage.setItem('onedrive_token_expires', Date.now() + (data.expires_in * 1000));
            
            // Check what scopes we actually got
            try {
                const tokenParts = data.access_token.split('.');
                if (tokenParts.length === 3) {
                    const payload = JSON.parse(atob(tokenParts[1].replace(/-/g, '+').replace(/_/g, '/')));
                    const receivedScopes = payload.scp || 'No scopes in token';
                    console.log('=== TOKEN RECEIVED ===');
                    console.log('Scopes we requested:', ONEDRIVE_CONFIG.scopes);
                    console.log('Scopes we received:', receivedScopes);
                    
                    const hasFiles = receivedScopes.includes('Files.ReadWrite');
                    const statusIcon = hasFiles ? '‚úÖ' : '‚ùå';
                    const statusText = hasFiles ? 'SUCCESS! Token has file permissions!' : 'PROBLEM: Token missing Files.ReadWrite';
                    
                    console.log(statusIcon, statusText);
                    
                    // Show alert
                    showMobileMessage(
                        hasFiles ? '‚úÖ Connected with File Access' : '‚ö†Ô∏è Connected Without File Access',
                        hasFiles ? 'Upload will work!' : `Token scopes: ${receivedScopes}\n\nMissing Files.ReadWrite! Upload will fail.`,
                        hasFiles ? 'success' : 'error'
                    );
                }
            } catch (e) {
                console.error('Could not decode token:', e);
            }
            
            // Get user info
            await getUserInfo();
            
            updateCloudStatus();
        }

        // Refresh access token when expired
        async function refreshAccessToken() {
            if (!oneDriveRefreshToken) {
                throw new Error('No refresh token available');
            }
            
            const tokenUrl = `https://login.microsoftonline.com/${ONEDRIVE_CONFIG.tenantId}/oauth2/v2.0/token`;
            
            const body = new URLSearchParams({
                client_id: ONEDRIVE_CONFIG.clientId,
                scope: ONEDRIVE_CONFIG.scopes,
                refresh_token: oneDriveRefreshToken,
                grant_type: 'refresh_token'
            });
            
            const response = await fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body.toString()
            });
            
            if (!response.ok) {
                throw new Error('Token refresh failed');
            }
            
            const data = await response.json();
            
            // Update tokens
            oneDriveToken = data.access_token;
            if (data.refresh_token) {
                oneDriveRefreshToken = data.refresh_token;
                localStorage.setItem('onedrive_refresh_token', data.refresh_token);
            }
            
            localStorage.setItem('onedrive_token', data.access_token);
            localStorage.setItem('onedrive_token_expires', Date.now() + (data.expires_in * 1000));
            
            return data.access_token;
        }

        // Disconnect OneDrive
        function disconnectOneDrive() {
            if (confirm('Are you sure you want to disconnect OneDrive?')) {
                localStorage.removeItem('onedrive_token');
                localStorage.removeItem('onedrive_refresh_token');
                localStorage.removeItem('onedrive_user_email');
                localStorage.removeItem('onedrive_token_expires');
                oneDriveToken = null;
                oneDriveRefreshToken = null;
                oneDriveUserEmail = null;
                updateCloudStatus();
                showMobileMessage('‚ÑπÔ∏è Disconnected', 'OneDrive disconnected', 'info');
            }
        }

        // Get user info from Microsoft Graph
        async function getUserInfo() {
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: {
                        'Authorization': `Bearer ${oneDriveToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    oneDriveUserEmail = data.userPrincipalName || data.mail;
                    localStorage.setItem('onedrive_user_email', oneDriveUserEmail);
                    updateCloudStatus();
                }
            } catch (error) {
                console.error('Error getting user info:', error);
            }
        }

        // Test file permissions - decode token and try creating a simple file
        async function testFilePermissions() {
            console.log('=== TESTING FILE PERMISSIONS ===');
            
            if (!oneDriveToken) {
                alert('‚ùå Not connected to OneDrive!\n\nPlease connect first by tapping the cloud icon.');
                return;
            }
            
            // Decode token to see scopes
            let tokenScopes = 'Could not decode token';
            let hasFilesReadWrite = false;
            
            try {
                const parts = oneDriveToken.split('.');
                if (parts.length === 3) {
                    const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                    tokenScopes = payload.scp || 'No scp field in token';
                    hasFilesReadWrite = tokenScopes.includes('Files.ReadWrite');
                    
                    console.log('Token scopes:', tokenScopes);
                    console.log('Has Files.ReadWrite?', hasFilesReadWrite);
                }
            } catch (e) {
                console.error('Error decoding token:', e);
            }
            
            // Show scopes to user
            const scopeMessage = `üîç YOUR TOKEN SCOPES:\n\n${tokenScopes}\n\n${hasFilesReadWrite ? '‚úÖ Has Files.ReadWrite' : '‚ùå MISSING Files.ReadWrite!'}`;
            alert(scopeMessage);
            
            if (!hasFilesReadWrite) {
                alert('‚ö†Ô∏è TOKEN PROBLEM\n\nYour token does NOT have Files.ReadWrite permission!\n\nEven though you granted consent, Microsoft did not include file permissions in your token.\n\nThis might be because the app is "unverified".');
                return;
            }
            
            // Try to create a simple test file in app folder
            showMobileMessage('üß™ Testing...', 'Trying to create a test file in OneDrive App folder...', 'info');
            
            try {
                const testContent = `Test file created at ${new Date().toISOString()}\nIf you can see this file, write permissions are working!`;
                const testUrl = 'https://graph.microsoft.com/v1.0/me/drive/special/approot:/test-permission-check.txt:/content';
                
                console.log('Attempting to create test file in app folder...');
                console.log('URL:', testUrl);
                
                const response = await fetch(testUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${oneDriveToken}`,
                        'Content-Type': 'text/plain'
                    },
                    body: testContent
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Success! File created:', data);
                    alert('‚úÖ SUCCESS!\n\nTest file created successfully in App folder!\n\nYour token has app folder permissions.\n\nCheck: OneDrive ‚Üí Apps ‚Üí Records Assessment Personal\n\nUpload will work now!');
                    showMobileMessage('‚úÖ Test Passed!', 'App folder permissions working! Uploads will go to OneDrive/Apps folder.', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Failed to create test file:', response.status, errorText);
                    
                    if (response.status === 403) {
                        alert('‚ùå 403 FORBIDDEN\n\nEven with Files.ReadWrite in token, Microsoft is blocking file creation!\n\nThis confirms the "unverified app" limitation.\n\nYou may need to:\n1. Verify the app with Microsoft\n2. Or use a different approach');
                    } else {
                        alert(`‚ùå ERROR ${response.status}\n\n${errorText}`);
                    }
                    showMobileMessage('‚ùå Test Failed', `Error ${response.status}: ${errorText}`, 'error');
                }
            } catch (error) {
                console.error('Test error:', error);
                alert(`‚ùå TEST ERROR\n\n${error.message}`);
                showMobileMessage('‚ùå Test Error', error.message, 'error');
            }
        }

        // Update cloud status indicator
        function updateCloudStatus() {
            const statusEl = document.getElementById('cloudStatus');
            const iconEl = document.getElementById('cloudIcon');
            const textEl = document.getElementById('cloudText');
            const cardEl = document.getElementById('connectionCard');
            const statusTextEl = document.getElementById('connectionStatus');
            const emailEl = document.getElementById('connectionEmail');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const folderSection = document.getElementById('folderSection');
            const uploadBtn = document.getElementById('oneDriveUploadBtn');
            
            if (oneDriveToken) {
                statusEl.className = 'cloud-status connected';
                textEl.textContent = 'OneDrive ‚úì';
                cardEl.className = 'connection-card connected';
                statusTextEl.textContent = 'Connected';
                emailEl.textContent = oneDriveUserEmail || 'Logged in';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                folderSection.style.display = 'block';
                if (uploadBtn) uploadBtn.disabled = false;
            } else {
                statusEl.className = 'cloud-status disconnected';
                textEl.textContent = 'Not Connected';
                cardEl.className = 'connection-card';
                statusTextEl.textContent = 'Not Connected';
                emailEl.textContent = 'Click Connect to link your OneDrive';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                folderSection.style.display = 'none';
                if (uploadBtn) uploadBtn.disabled = true;
            }
        }

        // Toggle settings panel
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('settingsOverlay');
            
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                panel.classList.add('open');
                overlay.classList.add('active');
                document.getElementById('oneDriveFolder').value = oneDriveFolder;
            }
        }

        // Save OneDrive folder path
        function saveOneDriveFolder() {
            const folder = document.getElementById('oneDriveFolder').value;
            oneDriveFolder = folder;
            localStorage.setItem('onedrive_folder', folder);
            showMobileMessage('‚úÖ Saved', 'Folder path updated', 'success');
        }

        // Show redirect URI helper
        function showRedirectUriHelper() {
            const infoDiv = document.getElementById('redirectUriInfo');
            const display = document.getElementById('redirectUriDisplay');
            
            // Get current redirect URI
            const currentUri = ONEDRIVE_CONFIG.redirectUri;
            display.value = currentUri;
            
            // Toggle display
            if (infoDiv.style.display === 'none') {
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Copy redirect URI to clipboard
        function copyRedirectUri() {
            const display = document.getElementById('redirectUriDisplay');
            display.select();
            display.setSelectionRange(0, 99999); // For mobile
            
            try {
                document.execCommand('copy');
                showMobileMessage('‚úÖ Copied!', 'Redirect URI copied to clipboard', 'success');
            } catch (err) {
                // Fallback for mobile
                showMobileMessage('üìã Copy', 'Please manually copy the URI above', 'info');
            }
        }

        // ========== Upload Functions ==========
        
        // Upload to OneDrive
        async function uploadToOneDrive() {
            if (!oneDriveToken) {
                showMobileMessage('‚ö†Ô∏è Not Connected', 'Please connect to OneDrive first. Tap the cloud icon in the top right.', 'error');
                return;
            }

            saveFormData();

            if (!currentAssessment.client.name) {
                showMobileMessage('‚ö†Ô∏è Error', 'Please complete the assessment before uploading.', 'error');
                return;
            }

            // Mark as complete
            currentAssessment.status = 'Complete';
            const index = assessments.findIndex(a => a.id === currentAssessment.id);
            if (index >= 0) {
                assessments[index] = currentAssessment;
            } else {
                assessments.push(currentAssessment);
            }
            localStorage.setItem('assessments', JSON.stringify(assessments));

            // Show upload modal
            showUploadModal();

            try {
                // Create ZIP package
                updateUploadProgress(0, 'Creating assessment package...');
                const zipBlob = await createCompletePackage();
                
                updateUploadProgress(30, 'Package created. Uploading to OneDrive...');
                
                // Generate filename
                const timestamp = new Date().toISOString().split('T')[0];
                const companyName = currentAssessment.client.name.replace(/[^a-z0-9]/gi, '_');
                const filename = `Assessment_${companyName}_${timestamp}.zip`;
                
                // Ensure folder path format
                let folderPath = oneDriveFolder.trim();
                if (!folderPath.startsWith('/')) folderPath = '/' + folderPath;
                if (!folderPath.endsWith('/')) folderPath += '/';
                
                // Upload to OneDrive
                await uploadFileToOneDrive(folderPath + filename, zipBlob);
                
                updateUploadProgress(100, 'Upload complete!');
                showUploadSuccess(filename);

            } catch (error) {
                console.error('Upload error:', error);
                
                // Check if token expired
                if (error.message.includes('401') || error.message.includes('token')) {
                    try {
                        await refreshAccessToken();
                        showMobileMessage('üîÑ Retrying', 'Refreshing connection...', 'info');
                        // Retry upload
                        setTimeout(() => uploadToOneDrive(), 1000);
                        return;
                    } catch (refreshError) {
                        showUploadError('Session expired. Please disconnect and reconnect OneDrive.');
                        return;
                    }
                }
                
                showUploadError(error.message);
            }
        }

        // Upload file to OneDrive App folder with retry
        async function uploadFileToOneDrive(path, blob, retryCount = 0) {
            // Use special approot folder - works for unverified apps!
            const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/special/approot:${path}:/content`;
            
            console.log('Uploading to app folder:', uploadUrl);
            
            updateUploadProgress(40 + (retryCount * 10), `Uploading... attempt ${retryCount + 1}`);
            
            const response = await fetch(uploadUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${oneDriveToken}`,
                    'Content-Type': 'application/zip'
                },
                body: blob
            });

            if (!response.ok) {
                if (response.status === 401 && retryCount === 0) {
                    // Token expired, refresh and retry
                    await refreshAccessToken();
                    return await uploadFileToOneDrive(path, blob, retryCount + 1);
                }
                
                const error = await response.text();
                throw new Error(`Upload failed: ${response.status} - ${error}`);
            }

            return await response.json();
        }

        // ========== ZIP Package Creation ==========
        
        // Create complete ZIP package
        async function createCompletePackage() {
            const zip = new JSZip();
            
            // Add JSON data
            const jsonData = createJSONExport();
            zip.file('data.json', JSON.stringify(jsonData, null, 2));
            
            // Add HTML report
            const htmlReport = createHTMLReport();
            zip.file('report.html', htmlReport);
            
            // Add Excel file
            const excelBlob = await createExcelBlob();
            zip.file('summary.xlsx', excelBlob);
            
            // Add photos
            const photosFolder = zip.folder('photos');
            await addPhotosToZip(photosFolder);
            
            // Generate ZIP
            return await zip.generateAsync({type: 'blob'});
        }

        // Create JSON export
        function createJSONExport() {
            return {
                version: '3.0-secure',
                exportDate: new Date().toISOString(),
                assessmentId: currentAssessment.id,
                status: currentAssessment.status,
                createdAt: currentAssessment.createdAt,
                updatedAt: currentAssessment.updatedAt,
                client: currentAssessment.client,
                sites: currentAssessment.sites,
                collections: currentAssessment.collections,
                metadata: {
                    totalPhotos: countTotalPhotos(),
                    totalCollections: currentAssessment.collections?.length || 0,
                    totalContainers: countTotalContainers(),
                    securityInfo: {
                        authMethod: 'PKCE (OAuth 2.0)',
                        noSecretsInCode: true
                    },
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language
                    }
                }
            };
        }

        // Count total photos
        function countTotalPhotos() {
            let count = 0;
            if (currentAssessment.sites) {
                currentAssessment.sites.forEach(site => {
                    site.buildings?.forEach(building => {
                        building.storageAreas?.forEach(area => {
                            count += area.photos?.length || 0;
                        });
                    });
                });
            }
            if (currentAssessment.collections) {
                currentAssessment.collections.forEach(collection => {
                    collection.containerTypes?.forEach(container => {
                        count += container.containerPhotos?.length || 0;
                        count += container.contentsPhotos?.length || 0;
                    });
                });
            }
            return count;
        }

        // Count total containers
        function countTotalContainers() {
            let count = 0;
            if (currentAssessment.collections) {
                currentAssessment.collections.forEach(collection => {
                    count += collection.containerTypes?.length || 0;
                });
            }
            return count;
        }

        // Create HTML report (similar to before)
        function createHTMLReport() {
            const companyName = currentAssessment.client.name;
            const date = new Date(currentAssessment.createdAt).toLocaleDateString();
            
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Assessment Report - ${companyName}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .info-grid { display: grid; grid-template-columns: 200px 1fr; gap: 10px; margin: 20px 0; }
        .label { font-weight: bold; color: #555; }
        .value { color: #333; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        .status { display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: bold; }
        .status-complete { background: #d4edda; color: #155724; }
        .security-badge { background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        @media print { body { background: white; margin: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Records Assessment Report <span class="security-badge">SECURE</span></h1>
        <div class="info-grid">
            <div class="label">Company:</div>
            <div class="value">${companyName}</div>
            <div class="label">Assessment Date:</div>
            <div class="value">${date}</div>
            <div class="label">Status:</div>
            <div class="value"><span class="status status-complete">${currentAssessment.status}</span></div>
            <div class="label">Assessment ID:</div>
            <div class="value">${currentAssessment.id}</div>
            <div class="label">Security:</div>
            <div class="value">PKCE OAuth 2.0 (No secrets in code)</div>
        </div>
        
        <h2>üìç Sites & Locations</h2>
        ${generateSitesHTML()}
        
        <h2>üì¶ Collections Summary</h2>
        ${generateCollectionsHTML()}
        
        <p style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee; color: #666; font-size: 14px;">
            Report generated on ${new Date().toLocaleString()}<br>
            Generated with secure PKCE authentication<br>
            For full data and photos, see accompanying files.
        </p>
    </div>
</body>
</html>`;
        }

        // Generate sites HTML for report
        function generateSitesHTML() {
            if (!currentAssessment.sites || currentAssessment.sites.length === 0) {
                return '<p>No sites recorded.</p>';
            }
            
            let html = '';
            currentAssessment.sites.forEach(site => {
                html += `<h3>${site.name}</h3>`;
                html += `<p><strong>Address:</strong> ${site.address || 'N/A'}</p>`;
                if (site.buildings) {
                    html += '<ul>';
                    site.buildings.forEach(building => {
                        html += `<li><strong>${building.name}</strong>`;
                        if (building.storageAreas) {
                            html += '<ul>';
                            building.storageAreas.forEach(area => {
                                html += `<li>${area.name} (${area.photos?.length || 0} photos)</li>`;
                            });
                            html += '</ul>';
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                }
            });
            return html;
        }

        // Generate collections HTML for report
        function generateCollectionsHTML() {
            if (!currentAssessment.collections || currentAssessment.collections.length === 0) {
                return '<p>No collections recorded.</p>';
            }
            
            let html = '<table><thead><tr><th>Collection</th><th>Record Type</th><th>Containers</th><th>Media Types</th></tr></thead><tbody>';
            currentAssessment.collections.forEach(collection => {
                html += `<tr>`;
                html += `<td>${collection.name}</td>`;
                html += `<td>${collection.recordType || 'N/A'}</td>`;
                html += `<td>${collection.containerTypes?.length || 0}</td>`;
                html += `<td>${collection.mediaTypes?.length || 0}</td>`;
                html += `</tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        // Create Excel blob
        async function createExcelBlob() {
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [[
                'Assessment Date', new Date(currentAssessment.createdAt).toLocaleDateString(),
                'Status', currentAssessment.status
            ], ['Company Name', currentAssessment.client.name], ['Security', 'PKCE OAuth 2.0']];
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
            
            const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
            return new Blob([wbout], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        }

        // Add photos to ZIP
        async function addPhotosToZip(photosFolder) {
            const timestamp = new Date().toISOString().split('T')[0];
            const companyName = currentAssessment.client.name.replace(/[^a-z0-9]/gi, '_');
            
            // Add storage area photos
            if (currentAssessment.sites) {
                for (const site of currentAssessment.sites) {
                    for (const building of site.buildings || []) {
                        for (const area of building.storageAreas || []) {
                            if (area.photos && area.photos.length > 0) {
                                for (let i = 0; i < area.photos.length; i++) {
                                    const photoData = area.photos[i].split(',')[1];
                                    const filename = `StorageArea_${area.name.replace(/[^a-z0-9]/gi, '_')}_${i + 1}_${timestamp}.jpg`;
                                    photosFolder.file(filename, photoData, {base64: true});
                                }
                            }
                        }
                    }
                }
            }
            
            // Add container and contents photos
            if (currentAssessment.collections) {
                for (const collection of currentAssessment.collections) {
                    for (let c = 0; c < (collection.containerTypes?.length || 0); c++) {
                        const container = collection.containerTypes[c];
                        
                        if (container.containerPhotos && container.containerPhotos.length > 0) {
                            for (let i = 0; i < container.containerPhotos.length; i++) {
                                const photoData = container.containerPhotos[i].split(',')[1];
                                const filename = `Container_${companyName}_${collection.name.replace(/[^a-z0-9]/gi, '_')}_${c + 1}_${i + 1}_${timestamp}.jpg`;
                                photosFolder.file(filename, photoData, {base64: true});
                            }
                        }
                        
                        if (container.contentsPhotos && container.contentsPhotos.length > 0) {
                            for (let i = 0; i < container.contentsPhotos.length; i++) {
                                const photoData = container.contentsPhotos[i].split(',')[1];
                                const filename = `Contents_${companyName}_${collection.name.replace(/[^a-z0-9]/gi, '_')}_${c + 1}_${i + 1}_${timestamp}.jpg`;
                                photosFolder.file(filename, photoData, {base64: true});
                            }
                        }
                    }
                }
            }
        }

        // Export complete package (without upload)
        async function exportCompletePackage() {
            saveFormData();
            showMobileMessage('üì¶ Creating Package', 'Please wait...', 'info');
            
            try {
                const zipBlob = await createCompletePackage();
                
                const timestamp = new Date().toISOString().split('T')[0];
                const companyName = currentAssessment.client.name.replace(/[^a-z0-9]/gi, '_');
                const filename = `Assessment_${companyName}_${timestamp}.zip`;
                
                const url = URL.createObjectURL(zipBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
                
                showMobileMessage('‚úÖ Success', 'Package downloaded! Check Safari Downloads (‚¨áÔ∏è icon)', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showMobileMessage('‚ö†Ô∏è Error', 'Failed to create package: ' + error.message, 'error');
            }
        }

        // ========== UI Functions ==========
        
        // Show upload modal
        function showUploadModal() {
            document.getElementById('uploadOverlay').classList.add('active');
            document.getElementById('uploadModal').classList.add('active');
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('uploadActions').style.display = 'none';
            document.getElementById('uploadTitle').textContent = 'Uploading to OneDrive...';
        }

        // Update upload progress
        function updateUploadProgress(percent, message) {
            document.getElementById('progressBarFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = message;
        }

        // Show upload success
        function showUploadSuccess(filename) {
            document.getElementById('uploadContent').innerHTML = `
                <div class="success-icon">‚úÖ</div>
                <h3>Upload Successful!</h3>
                <p style="font-size: 14px; color: #666; margin: 15px 0;">
                    <strong>File:</strong> ${filename}<br>
                    <strong>Location:</strong> OneDrive ‚Üí Apps ‚Üí Records Assessment Personal<br>
                    <strong>Security:</strong> <span class="security-badge">PKCE</span>
                </p>
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
                    ‚úì File uploaded to your app folder<br>
                    ‚úì Open OneDrive ‚Üí Apps ‚Üí Records Assessment Personal<br>
                    ‚úì Securely authenticated with PKCE
                </div>
                <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 12px; border: 1px solid #ffc107;">
                    ‚ÑπÔ∏è Files are in your app folder (not main OneDrive) because this app is unverified. You can move them to other folders from OneDrive.
                </div>
            `;
            document.getElementById('uploadActions').style.display = 'flex';
            document.getElementById('uploadActions').innerHTML = `
                <button class="btn btn-primary" onclick="closeUploadModal()" style="flex: 1; margin-bottom: 0;">Done</button>
            `;
        }

        // Show upload error
        function showUploadError(errorMessage) {
            document.getElementById('uploadContent').innerHTML = `
                <div class="error-icon">‚ö†Ô∏è</div>
                <h3>Upload Failed</h3>
                <p style="font-size: 14px; color: #666; margin: 15px 0;">
                    ${errorMessage}
                </p>
                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px; color: #721c24;">
                    Please check your OneDrive connection and try again.
                </div>
            `;
            document.getElementById('uploadActions').style.display = 'flex';
            document.getElementById('uploadActions').innerHTML = `
                <button class="btn btn-secondary" onclick="exportCompletePackage()" style="flex: 1; margin-bottom: 0;">Save to Phone Instead</button>
                <button class="btn btn-primary" onclick="closeUploadModal(); uploadToOneDrive();" style="flex: 1; margin-bottom: 0;">Try Again</button>
            `;
        }

        // Close upload modal
        function closeUploadModal() {
            document.getElementById('uploadOverlay').classList.remove('active');
            document.getElementById('uploadModal').classList.remove('active');
        }
    </script>
</body>
</html>
